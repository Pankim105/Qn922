# PromptBuilder 优化总结

## 优化内容

### 1. 从数据库读取世界模板信息
- **问题**: 之前硬编码了不同世界的角色定义和行为规则
- **解决方案**: 修改 `buildCharacterDefinition()` 和 `buildBehaviorRules()` 方法，从数据库的 `WorldTemplate` 表中读取信息
- **具体改动**:
  - `buildCharacterDefinition()`: 优先使用 `systemPromptTemplate`，其次使用 `dmInstructions`
  - `buildBehaviorRules()`: 使用 `getWorldSpecificRules()` 方法从数据库读取 `defaultRules`
  - 添加了 `getWorldSpecificRules()` 辅助方法

### 2. 抽象化返回格式示例
- **问题**: 提示词中包含了过于具体的故事情节示例，可能导致大模型产生误解
- **解决方案**: 将所有具体示例替换为抽象化的模板格式
- **具体改动**:
  - `[WORLD]` 块: 从具体场景描述改为 `📍 当前位置: [具体位置描述]; 🌅 时间: [时间描述]` 等模板格式
  - `[QUESTS]` 块: 从具体任务改为 `1. [任务标题]: [任务描述]，进度[当前/目标]（奖励：[奖励描述]）` 格式
  - `[CHOICES]` 块: 从具体选择改为 `1. [选择标题] - [选择描述]` 格式
  - `[DIALOGUE]` 块: 从具体对话改为 `[场景描述]: [具体场景描述]; [角色动作]: [角色行为描述]` 格式
  - 评估JSON: 从具体示例改为抽象化的字段说明格式

### 3. 保持前端渲染兼容性
- **确保**: 所有格式变更都与前端渲染逻辑兼容
- **验证**: 前端使用分号分隔和表情符号前缀的解析逻辑保持不变
- **格式要求**:
  - `[WORLD]` 块: 使用分号分隔的键值对，支持表情符号前缀
  - `[QUESTS]` 块: 使用分号分隔的任务列表
  - `[CHOICES]` 块: 使用分号分隔的选择项
  - `[DIALOGUE]` 块: 使用分号分隔的对话模块

## 技术细节

### 数据库字段映射
- `systemPromptTemplate` → 角色定义
- `dmInstructions` → DM指令（备选）
- `defaultRules` → 世界特定规则
- `description` → 世界描述
- `locationTemplates` → 地点模板
- `convergenceScenarios` → 收敛场景
- `convergenceRules` → 收敛规则

### 降级处理
- 当数据库查询失败时，提供默认的降级处理
- 确保系统在数据库不可用时仍能正常工作

### 错误处理
- 添加了适当的异常处理和日志记录
- 使用 `logger.warn()` 记录非致命错误

## 优势

1. **动态配置**: 世界规则和角色定义可以通过数据库动态配置，无需修改代码
2. **避免误解**: 抽象化的格式示例避免了具体故事情节对大模型的误导
3. **维护性**: 减少了硬编码，提高了代码的可维护性
4. **扩展性**: 新增世界类型时只需在数据库中配置，无需修改代码
5. **一致性**: 确保提示词格式与前端渲染逻辑保持一致

## 注意事项

- 数据库中的JSON字段需要正确格式化
- 空值检查确保不会出现空指针异常
- 保持与现有前端渲染逻辑的兼容性
- 定期验证数据库中的世界模板数据完整性
