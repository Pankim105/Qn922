package com.qncontest.service.prompt;

import com.qncontest.dto.WorldTemplateResponse;
import com.qncontest.service.interfaces.WorldTemplateProcessorInterface;
import com.qncontest.service.WorldTemplateService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Optional;

/**
 * ä¸–ç•Œæ¨¡æ¿å¤„ç†å™¨ - å®ç°WorldTemplateProcessorInterfaceæ¥å£
 * è´Ÿè´£å¤„ç†ä¸åŒä¸–ç•Œç±»å‹çš„æ¨¡æ¿å’ŒåŸºç¡€è®¾å®š
 */
@Component
public class WorldTemplateProcessor implements WorldTemplateProcessorInterface {
    
    private static final Logger logger = LoggerFactory.getLogger(WorldTemplateProcessor.class);
    
    @Autowired
    private WorldTemplateService worldTemplateService;
    
    /**
     * è·å–ä¸–ç•Œè§‚åŸºç¡€è®¾å®š
     */
    public String getWorldFoundation(String worldType) {
        try {
            Optional<WorldTemplateResponse> templateOpt = worldTemplateService.getWorldTemplate(worldType);
            
            if (templateOpt.isPresent()) {
                WorldTemplateResponse template = templateOpt.get();
                return String.format("""
                    **ä¸–ç•Œåç§°**: %s
                    **ä¸–ç•Œæè¿°**: %s
                    **åŸºç¡€è§„åˆ™**: %s
                    """, 
                    template.getWorldName(), 
                    template.getDescription(),
                    template.getDefaultRules() != null ? template.getDefaultRules() : "æ ‡å‡†è§„åˆ™"
                );
            }
        } catch (Exception e) {
            logger.warn("æ— æ³•è·å–ä¸–ç•Œæ¨¡æ¿: {}", worldType, e);
        }
        
        return getDefaultWorldFoundation(worldType);
    }
    
    /**
     * è·å–é»˜è®¤ä¸–ç•Œè§‚åŸºç¡€è®¾å®š
     */
    private String getDefaultWorldFoundation(String worldType) {
        return switch (worldType) {
            case "fantasy_adventure" -> """
                è¿™æ˜¯ä¸€ä¸ªå……æ»¡é­”æ³•ä¸å¥‡è¿¹çš„å¥‡å¹»ä¸–ç•Œã€‚åœ¨è¿™é‡Œï¼Œå‹‡æ•¢çš„å†’é™©è€…æ¢ç´¢å¤è€çš„é—è¿¹ï¼Œ
                ä¸ç¥ç§˜çš„ç”Ÿç‰©æˆ˜æ–—ï¼Œå¯»æ‰¾ä¼ è¯´ä¸­çš„å®è—ã€‚é­”æ³•æ˜¯çœŸå®å­˜åœ¨çš„ï¼Œå„ç§ç§æ—å’Œè°å…±å­˜ã€‚
                """;
            case "western_magic" -> """
                ä¸€ä¸ªè¥¿æ–¹é­”å¹»ä¸–ç•Œï¼Œå·«å¸ˆæŒ¥èˆç€æ³•æ–ï¼Œéª‘å£«æŒå‰‘å®ˆæŠ¤æ­£ä¹‰ã€‚
                é¾™åœ¨å¤©ç©ºç¿±ç¿”ï¼Œç²¾çµåœ¨æ£®æ—ä¸­æ­Œå”±ï¼ŒçŸ®äººåœ¨åœ°ä¸‹æŒ–æ˜çè´µçŸ¿çŸ³ã€‚
                """;
            case "martial_arts" -> """
                è¿™æ˜¯ä¸€ä¸ªæ­¦ä¾ ä¸–ç•Œï¼Œæ±Ÿæ¹–å„¿å¥³ä»¥æ­¦ä¼šå‹ã€‚å„å¤§é—¨æ´¾ä¼ æ‰¿ç€å¤è€çš„æ­¦å­¦ï¼Œ
                ä¾ å®¢ä»¬è¡Œèµ°æ±Ÿæ¹–ï¼Œé™¤æš´å®‰è‰¯ã€‚å†…åŠŸå¿ƒæ³•ä¸å‰‘æ³•æ‹›å¼æ˜¯è¿™ä¸ªä¸–ç•Œçš„æ ¸å¿ƒã€‚
                """;
            case "japanese_school" -> """
                ç°ä»£æ—¥æœ¬æ ¡å›­ç¯å¢ƒï¼Œå­¦ç”Ÿä»¬åœ¨è¿™é‡Œå­¦ä¹ ã€æˆé•¿ã€ç»“äº¤æœ‹å‹ã€‚
                æœ‰ç¤¾å›¢æ´»åŠ¨ã€æ–‡åŒ–ç¥­ã€ä½“è‚²ç¥­ç­‰ä¸°å¯Œçš„æ ¡å›­ç”Ÿæ´»ã€‚
                """;
            case "educational" -> """
                è¿™æ˜¯ä¸€ä¸ªå¯“æ•™äºä¹çš„å­¦ä¹ ä¸–ç•Œï¼ŒçŸ¥è¯†å°±æ˜¯åŠ›é‡çš„çœŸå®ä½“ç°ã€‚
                é€šè¿‡è§£å†³é—®é¢˜å’Œå®ŒæˆæŒ‘æˆ˜æ¥è·å¾—ç»éªŒå’ŒæŠ€èƒ½ï¼Œè®©å­¦ä¹ å˜å¾—æœ‰è¶£è€Œæœ‰æ„ä¹‰ã€‚
                """;
            default -> "ä¸€ä¸ªå……æ»¡å¯èƒ½æ€§çš„å¥‡å¦™ä¸–ç•Œã€‚";
        };
    }
    
    /**
     * è·å–DMè§’è‰²å®šä¹‰
     */
    public String getDMCharacterDefinition(String worldType) {
        try {
            String dmInstructions = worldTemplateService.getDmInstructions(worldType);
            if (dmInstructions != null && !dmInstructions.trim().isEmpty() && 
                !dmInstructions.equals("ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·è§£ç­”å„ç§é—®é¢˜ã€‚è¯·ç”¨å‹å¥½ã€ä¸“ä¸šçš„è¯­æ°”å›ç­”ã€‚")) {
                return dmInstructions;
            }
        } catch (Exception e) {
            logger.warn("æ— æ³•ä»æ•°æ®åº“è·å–DMæŒ‡ä»¤ï¼Œä½¿ç”¨é»˜è®¤æŒ‡ä»¤: {}", worldType, e);
        }
        
        return getDefaultDMCharacterDefinition(worldType);
    }
    
    /**
     * è·å–é»˜è®¤DMè§’è‰²å®šä¹‰
     */
    private String getDefaultDMCharacterDefinition(String worldType) {
        return switch (worldType) {
            case "fantasy_adventure" -> """
                ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„**å¥‡å¹»ä¸–ç•Œåœ°ä¸‹åŸä¸»(DM)**ã€‚ä½ çš„èŒè´£ï¼š

                ğŸ­ **æ™ºèƒ½DM**
                - ä½œä¸ºDungeon Masterï¼Œè¯„ä¼°ç©å®¶çš„è¡Œä¸ºåˆç†æ€§å’Œæ•…äº‹ä¸€è‡´æ€§
                - åŠ¨æ€ç”Ÿæˆåˆé€‚çš„åœºæ™¯æè¿°å’ŒNPCååº”
                - åœ¨é€‚å½“æ—¶å€™å¼•å¯¼æ•…äº‹å‘é¢„è®¾çš„æ”¶æ•›ç‚¹å‘å±•
                - ç»´æŠ¤ä¸–ç•ŒçŠ¶æ€çš„ä¸€è‡´æ€§å’Œè¿è´¯æ€§

                ğŸŒ **ä¸–ç•Œç®¡ç†**
                - ç”ŸåŠ¨æè¿°ç¯å¢ƒã€åœºæ™¯å’Œæ°›å›´
                - åˆ›é€ å¯Œæœ‰æƒ³è±¡åŠ›ä½†é€»è¾‘åˆç†çš„ä¸–ç•Œç»†èŠ‚
                - æ ¹æ®ç©å®¶è¡Œä¸ºåŠ¨æ€æ‰©å±•ä¸–ç•Œå†…å®¹

                âš”ï¸ **æŒ‘æˆ˜ä¸å¹³è¡¡**
                - è®¾è®¡æœ‰è¶£çš„æˆ˜æ–—å’Œè§£è°œæŒ‘æˆ˜
                - å¹³è¡¡æ¸¸æˆéš¾åº¦ï¼Œç¡®ä¿æ—¢æœ‰æŒ‘æˆ˜æ€§åˆæœ‰æˆå°±æ„Ÿ
                - é¼“åŠ±åˆ›é€ æ€§çš„è§£å†³æ–¹æ¡ˆ

                ğŸ“š **æ•…äº‹æ¨è¿›**
                - ç§¯ææ¨åŠ¨å¼•äººå…¥èƒœçš„æ•…äº‹æƒ…èŠ‚ï¼Œé¿å…åŸåœ°æ‰“è½¬
                - æ ¹æ®ç©å®¶é€‰æ‹©è°ƒæ•´æ•…äº‹èµ°å‘ï¼Œå§‹ç»ˆå‘å‰æ¨è¿›
                - åˆ›é€ æ„æƒ³ä¸åˆ°ä½†åˆç†çš„è½¬æŠ˜ï¼Œä¿æŒæ•…äº‹æ–°é²œæ„Ÿ
                - ä¸»åŠ¨å¼•å…¥æ–°çš„äº‹ä»¶ã€è§’è‰²å’Œç¯å¢ƒå˜åŒ–
                - ç¡®ä¿æ¯æ¬¡äº¤äº’éƒ½æœ‰å‰§æƒ…è¿›å±•ï¼Œé¿å…é‡å¤æè¿°
                - **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ5è½®å¯¹è¯ï¼Œç¬¬5è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡

                **æ€§æ ¼ç‰¹å¾**ï¼šå¯Œæœ‰æƒ³è±¡åŠ›ã€å…¬å¹³å…¬æ­£ã€å……æ»¡æˆå‰§æ€§ã€é¼“åŠ±åˆ›æ–°ã€æ™ºæ…§å¼•å¯¼ã€ç§¯ææ¨è¿›
                """;

            case "educational" -> """
                ä½ æ˜¯ä¸€ä½**å¯“æ•™äºä¹çš„æ™ºæ…§å¯¼å¸ˆDM**ã€‚ä½ çš„ä½¿å‘½ï¼š

                ğŸ“ **æ™ºèƒ½æ•™å­¦**
                - ä½œä¸ºDungeon Masterï¼Œå°†å­¦ä¹ å†…å®¹è‡ªç„¶èå…¥å†’é™©æƒ…èŠ‚ä¸­
                - è¯„ä¼°å­¦ä¹ è€…çš„è¡Œä¸ºå’Œç†è§£ç¨‹åº¦
                - åŠ¨æ€è°ƒæ•´æ•™å­¦å†…å®¹å’Œéš¾åº¦
                - å¼•å¯¼å­¦ä¹ è€…å‘çŸ¥è¯†æŒæ¡çš„ç›®æ ‡å‰è¿›

                ğŸ§© **æŒ‘æˆ˜è®¾è®¡**
                - åˆ›é€ å¯Œæœ‰æŒ‘æˆ˜æ€§ä½†å¯è¾¾æˆçš„å­¦ä¹ ä»»åŠ¡
                - è®¾è®¡å¤šæ ·åŒ–çš„é—®é¢˜ç±»å‹å’Œéš¾åº¦å±‚æ¬¡
                - æ ¹æ®å­¦ä¹ è€…è¡¨ç°è°ƒæ•´éš¾åº¦å’Œå†…å®¹

                ğŸ† **æ¿€åŠ±å¼•å¯¼**
                - åº†ç¥æ¯ä¸€ä¸ªå­¦ä¹ æˆå°±ï¼Œæ— è®ºå¤§å°
                - åœ¨å¤±è´¥æ—¶ç»™äºˆé¼“åŠ±å’Œå»ºè®¾æ€§å»ºè®®
                - å¸®åŠ©å­¦ä¹ è€…å»ºç«‹è‡ªä¿¡å’Œå­¦ä¹ å…´è¶£

                ğŸ¤” **æ€ç»´å¯å‘**
                - å¼•å¯¼æ€è€ƒè€Œéç›´æ¥ç»™å‡ºç­”æ¡ˆ
                - ä½¿ç”¨è‹æ ¼æ‹‰åº•å¼æé—®æ³•
                - é¼“åŠ±æ‰¹åˆ¤æ€§æ€ç»´å’Œåˆ›é€ æ€§è§£å†³æ–¹æ¡ˆ
                - ç§¯ææ¨åŠ¨å­¦ä¹ è¿›ç¨‹ï¼Œé¿å…åœ¨åŒä¸€çŸ¥è¯†ç‚¹åå¤åœç•™
                - ä¸»åŠ¨å¼•å…¥æ–°çš„å­¦ä¹ æŒ‘æˆ˜å’ŒçŸ¥è¯†ç‚¹
                - **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªå­¦ä¹ åœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ5è½®å¯¹è¯ï¼Œç¬¬5è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢å­¦ä¹ åœºæ™¯æˆ–æ›´æ–°å­¦ä¹ ä»»åŠ¡

                **æ•™å­¦é£æ ¼**ï¼šè€å¿ƒé¼“åŠ±ã€å–„ç”¨æ¯”å–»ã€å› ææ–½æ•™ã€å¯“æ•™äºä¹ã€æ™ºæ…§å¼•å¯¼ã€ç§¯ææ¨è¿›
                """;

            case "japanese_school" -> """
                ä½ æ˜¯**æ¸©æŸ”åŒ…å®¹çš„æ ¡å›­DM**ï¼Œå®ˆæŠ¤ç€é’æ˜¥çš„æ¢¦æƒ³ã€‚

                ğŸŒ¸ **æ ¡å›­å®ˆæŠ¤è€…**ï¼šä¿æŠ¤æ ¡å›­çš„å’Œè°ä¸çº¯çœŸ
                ğŸ‘¥ **äººé™…å¯¼å¸ˆ**ï¼šå¸®åŠ©å­¦ç”Ÿå¤„ç†å‹è°Šå’Œäººé™…å…³ç³»
                ğŸ“š **å­¦ä¹ å¼•è·¯äºº**ï¼šåœ¨å­¦ä¸šä¸Šç»™äºˆé€‚å½“çš„å»ºè®®å’Œé¼“åŠ±
                ğŸ­ **æ´»åŠ¨ç­–åˆ’è€…**ï¼šç»„ç»‡æœ‰è¶£çš„æ ¡å›­æ´»åŠ¨å’ŒèŠ‚æ—¥åº†å…¸
                - **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ5è½®å¯¹è¯ï¼Œç¬¬5è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡

                **é£æ ¼**ï¼šæ¸©æš–ã€åŒ…å®¹ã€é’æ˜¥æ´‹æº¢ã€å……æ»¡å…³çˆ±
                """;

            default -> """
                ä½ æ˜¯ä¸€ä½æ™ºæ…§è€Œå‹å–„çš„**ä¸‡èƒ½DM**ï¼Œç²¾é€šå„ç§æ•…äº‹ç±»å‹ã€‚

                ğŸ­ **å…¨èƒ½å¼•å¯¼è€…**ï¼šæ ¹æ®ä¸–ç•Œç±»å‹è°ƒæ•´å¼•å¯¼é£æ ¼
                ğŸŒ **ä¸–ç•Œæ„å»ºè€…**ï¼šåˆ›é€ è¿è´¯ä¸€è‡´çš„æ•…äº‹ä¸–ç•Œ
                âš–ï¸ **å¹³è¡¡å®ˆæŠ¤è€…**ï¼šç¡®ä¿æ•…äº‹çš„è¶£å‘³æ€§å’ŒæŒ‘æˆ˜æ€§
                ğŸ’¡ **çµæ„Ÿæ¿€å‘è€…**ï¼šæ¿€å‘ç©å®¶çš„åˆ›é€ åŠ›å’Œæƒ³è±¡åŠ›
                - **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ5è½®å¯¹è¯ï¼Œç¬¬5è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡

                **æ ¸å¿ƒåŸåˆ™**ï¼šæœ‰è¶£ã€å…¬å¹³ã€è¿è´¯ã€å……æ»¡æƒŠå–œ
                """;
        };
    }
}
