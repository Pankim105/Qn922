package com.qncontest.service;

import com.qncontest.entity.ChatSession;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Arrays;
import java.util.List;
import java.util.Optional;
import java.util.ArrayList;

/**
 * è§’è‰²æ‰®æ¼”æ™ºèƒ½æç¤ºå¼•æ“
 * è´Ÿè´£æ„å»ºåˆ†å±‚ã€æ™ºèƒ½çš„è§’è‰²æ‰®æ¼”æç¤ºè¯
 */
@Service
public class RoleplayPromptEngine {
    
    private static final Logger logger = LoggerFactory.getLogger(RoleplayPromptEngine.class);
    
    @Autowired
    private WorldTemplateService worldTemplateService;
    
    @Autowired
    private RoleplayMemoryService memoryService;
    
    /**
     * è§’è‰²æ‰®æ¼”ä¸Šä¸‹æ–‡
     */
    public static class RoleplayContext {
        private String worldType;
        private String sessionId;
        private String currentMessage;
        private String worldState;
        private String skillsState;
        private String godModeRules;
        private ChatSession session;
        
        // Constructor
        public RoleplayContext(String worldType, String sessionId) {
            this.worldType = worldType;
            this.sessionId = sessionId;
        }
        
        // Getters and Setters
        public String getWorldType() { return worldType; }
        public void setWorldType(String worldType) { this.worldType = worldType; }
        
        public String getSessionId() { return sessionId; }
        public void setSessionId(String sessionId) { this.sessionId = sessionId; }
        
        public String getCurrentMessage() { return currentMessage; }
        public void setCurrentMessage(String currentMessage) { this.currentMessage = currentMessage; }
        
        public String getWorldState() { return worldState; }
        public void setWorldState(String worldState) { this.worldState = worldState; }
        
        public String getSkillsState() { return skillsState; }
        public void setSkillsState(String skillsState) { this.skillsState = skillsState; }
        
        public String getGodModeRules() { return godModeRules; }
        public void setGodModeRules(String godModeRules) { this.godModeRules = godModeRules; }
        
        public ChatSession getSession() { return session; }
        public void setSession(ChatSession session) { this.session = session; }
    }
    
    /**
     * æ„å»ºåˆ†å±‚è§’è‰²æ‰®æ¼”æç¤º
     */
    public String buildLayeredPrompt(RoleplayContext context) {
        StringBuilder prompt = new StringBuilder();
        
        // ç¬¬1å±‚ï¼šä¸–ç•Œè§‚åŸºç¡€
        prompt.append("# ğŸŒ ä¸–ç•Œè§‚è®¾å®š\n");
        prompt.append(getWorldFoundation(context.getWorldType()));
        prompt.append("\n\n");
        
        // ç¬¬2å±‚ï¼šè§’è‰²å®šä¹‰
        prompt.append("# ğŸ­ ä½ çš„è§’è‰²\n");
        prompt.append(buildCharacterDefinition(context));
        prompt.append("\n\n");
        
        // ç¬¬3å±‚ï¼šå½“å‰çŠ¶æ€
        prompt.append("# ğŸ“ å½“å‰çŠ¶æ€\n");
        prompt.append(buildCurrentState(context));
        prompt.append("\n\n");
        
        // ç¬¬4å±‚ï¼šè®°å¿†ä¸Šä¸‹æ–‡
        String memoryContext = memoryService.buildMemoryContext(context.getSessionId(), context.getCurrentMessage());
        if (!memoryContext.isEmpty()) {
            prompt.append("# ğŸ§  ç›¸å…³è®°å¿†\n");
            prompt.append(memoryContext);
            prompt.append("\n\n");
        }

        // ç¬¬4.5å±‚ï¼šè®°å¿†æ›´æ–°æŒ‡ä»¤ï¼ˆæ–°å¢ï¼‰
        prompt.append("# ğŸ’­ è®°å¿†ç®¡ç†æŒ‡ä»¤\n");
        prompt.append("""
            ## è®°å¿†æ›´æ–°è§„åˆ™
            å½“ä½ ç”Ÿæˆå›å¤æ—¶ï¼Œè¯·æ³¨æ„ä»¥ä¸‹è®°å¿†ç®¡ç†åŸåˆ™ï¼š

            1. **é‡è¦ä¿¡æ¯è¯†åˆ«**ï¼šå¦‚æœå›å¤ä¸­åŒ…å«é‡è¦çš„äº‹ä»¶ã€è§’è‰²å…³ç³»å˜åŒ–ã€æŠ€èƒ½æå‡ç­‰ä¿¡æ¯ï¼Œè¯·åœ¨å›å¤æœ«å°¾æ·»åŠ è®°å¿†æ ‡è®°
            2. **è®°å¿†æ ‡è®°æ ¼å¼**ï¼šä½¿ç”¨ä»¥ä¸‹æ ¼å¼è®°å½•é‡è¦è®°å¿†ï¼š
               - è§’è‰²å…³ç³»å˜åŒ–ï¼š[MEMORY:CHARACTER:è§’è‰²å:å…³ç³»å˜åŒ–]
               - é‡è¦äº‹ä»¶ï¼š[MEMORY:EVENT:äº‹ä»¶æè¿°]
               - ä¸–ç•ŒçŠ¶æ€å˜åŒ–ï¼š[MEMORY:WORLD:çŠ¶æ€å˜åŒ–:åŸå› ]
               - æŠ€èƒ½å­¦ä¹ ï¼š[MEMORY:SKILL:æŠ€èƒ½å:å­¦ä¹ æƒ…å†µ]

            3. **è®°å¿†é‡è¦æ€§**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨è¯„ä¼°è®°å¿†é‡è¦æ€§ï¼Œåªæœ‰é‡è¦æ€§>0.6çš„è®°å¿†ä¼šè¢«ä¿å­˜

            4. **è®°å¿†æå–**ï¼šå¦‚æœå›å¤ä¸­åŒ…å«éœ€è¦è®°å¿†çš„å†…å®¹ï¼Œè¯·ç¡®ä¿å†…å®¹æ¸…æ™°ã€å…·ä½“ï¼Œä¾¿äºåç»­æ£€ç´¢

            ç¤ºä¾‹ï¼š
            å¦‚æœä½ å›å¤ï¼š"ä½ å­¦ä¼šäº†ç«çƒæœ¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ”»å‡»æŠ€èƒ½ã€‚"
            è¯·åœ¨å›å¤æœ«å°¾æ·»åŠ ï¼š[MEMORY:SKILL:ç«çƒæœ¯:å­¦ä¼šäº†åŸºç¡€ç«çƒæœ¯æ”»å‡»æŠ€èƒ½]

            """);
        prompt.append("\n\n");

        // ç¬¬5å±‚ï¼šè¡Œä¸ºè§„åˆ™
        prompt.append("# âš–ï¸ è¡Œä¸ºå‡†åˆ™\n");
        prompt.append(buildBehaviorRules(context));
        prompt.append("\n\n");
        
        // ç¬¬6å±‚ï¼šæŠ€èƒ½é›†æˆ
        prompt.append("# ğŸ› ï¸ å¯ç”¨æŠ€èƒ½\n");
        prompt.append(buildSkillInstructions(context));
        
        return prompt.toString();
    }
    
    /**
     * è·å–ä¸–ç•Œè§‚åŸºç¡€è®¾å®š
     */
    private String getWorldFoundation(String worldType) {
        try {
            Optional<com.qncontest.dto.WorldTemplateResponse> templateOpt = worldTemplateService.getWorldTemplate(worldType);
            
            if (templateOpt.isPresent()) {
                com.qncontest.dto.WorldTemplateResponse template = templateOpt.get();
                return String.format("""
                    **ä¸–ç•Œåç§°**: %s
                    **ä¸–ç•Œæè¿°**: %s
                    **åŸºç¡€è§„åˆ™**: %s
                    """, 
                    template.getWorldName(), 
                    template.getDescription(),
                    template.getDefaultRules() != null ? template.getDefaultRules() : "æ ‡å‡†è§„åˆ™"
                );
            }
        } catch (Exception e) {
            logger.warn("æ— æ³•è·å–ä¸–ç•Œæ¨¡æ¿: {}", worldType, e);
        }
        
        return switch (worldType) {
            case "fantasy_adventure" -> """
                è¿™æ˜¯ä¸€ä¸ªå……æ»¡é­”æ³•ä¸å¥‡è¿¹çš„å¥‡å¹»ä¸–ç•Œã€‚åœ¨è¿™é‡Œï¼Œå‹‡æ•¢çš„å†’é™©è€…æ¢ç´¢å¤è€çš„é—è¿¹ï¼Œ
                ä¸ç¥ç§˜çš„ç”Ÿç‰©æˆ˜æ–—ï¼Œå¯»æ‰¾ä¼ è¯´ä¸­çš„å®è—ã€‚é­”æ³•æ˜¯çœŸå®å­˜åœ¨çš„ï¼Œå„ç§ç§æ—å’Œè°å…±å­˜ã€‚
                """;
            case "western_magic" -> """
                ä¸€ä¸ªè¥¿æ–¹é­”å¹»ä¸–ç•Œï¼Œå·«å¸ˆæŒ¥èˆç€æ³•æ–ï¼Œéª‘å£«æŒå‰‘å®ˆæŠ¤æ­£ä¹‰ã€‚
                é¾™åœ¨å¤©ç©ºç¿±ç¿”ï¼Œç²¾çµåœ¨æ£®æ—ä¸­æ­Œå”±ï¼ŒçŸ®äººåœ¨åœ°ä¸‹æŒ–æ˜çè´µçŸ¿çŸ³ã€‚
                """;
            case "martial_arts" -> """
                è¿™æ˜¯ä¸€ä¸ªæ­¦ä¾ ä¸–ç•Œï¼Œæ±Ÿæ¹–å„¿å¥³ä»¥æ­¦ä¼šå‹ã€‚å„å¤§é—¨æ´¾ä¼ æ‰¿ç€å¤è€çš„æ­¦å­¦ï¼Œ
                ä¾ å®¢ä»¬è¡Œèµ°æ±Ÿæ¹–ï¼Œé™¤æš´å®‰è‰¯ã€‚å†…åŠŸå¿ƒæ³•ä¸å‰‘æ³•æ‹›å¼æ˜¯è¿™ä¸ªä¸–ç•Œçš„æ ¸å¿ƒã€‚
                """;
            case "japanese_school" -> """
                ç°ä»£æ—¥æœ¬æ ¡å›­ç¯å¢ƒï¼Œå­¦ç”Ÿä»¬åœ¨è¿™é‡Œå­¦ä¹ ã€æˆé•¿ã€ç»“äº¤æœ‹å‹ã€‚
                æœ‰ç¤¾å›¢æ´»åŠ¨ã€æ–‡åŒ–ç¥­ã€ä½“è‚²ç¥­ç­‰ä¸°å¯Œçš„æ ¡å›­ç”Ÿæ´»ã€‚
                """;
            case "educational" -> """
                è¿™æ˜¯ä¸€ä¸ªå¯“æ•™äºä¹çš„å­¦ä¹ ä¸–ç•Œï¼ŒçŸ¥è¯†å°±æ˜¯åŠ›é‡çš„çœŸå®ä½“ç°ã€‚
                é€šè¿‡è§£å†³é—®é¢˜å’Œå®ŒæˆæŒ‘æˆ˜æ¥è·å¾—ç»éªŒå’ŒæŠ€èƒ½ï¼Œè®©å­¦ä¹ å˜å¾—æœ‰è¶£è€Œæœ‰æ„ä¹‰ã€‚
                """;
            default -> "ä¸€ä¸ªå……æ»¡å¯èƒ½æ€§çš„å¥‡å¦™ä¸–ç•Œã€‚";
        };
    }
    
    /**
     * æ„å»ºè§’è‰²å®šä¹‰
     */
    private String buildCharacterDefinition(RoleplayContext context) {
        return switch (context.getWorldType()) {
            case "fantasy_adventure" -> """
                ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„**å¥‡å¹»ä¸–ç•Œæ¸¸æˆä¸»æŒäºº(DM)**ã€‚ä½ çš„èŒè´£ï¼š
                
                ğŸ­ **è§’è‰²æ‰®æ¼”**
                - æ‰®æ¼”ä¸–ç•Œä¸­çš„æ‰€æœ‰NPCï¼Œæ¯ä¸ªéƒ½æœ‰ç‹¬ç‰¹çš„æ€§æ ¼å’ŒèƒŒæ™¯
                - ä¸ºæ¯ä¸ªè§’è‰²èµ‹äºˆç”ŸåŠ¨çš„å¯¹è¯é£æ ¼å’Œè¡Œä¸ºç‰¹å¾
                - æ ¹æ®æƒ…å†µè°ƒæ•´NPCçš„æ€åº¦å’Œååº”
                
                ğŸŒ **ä¸–ç•Œæ„å»º**
                - ç”ŸåŠ¨æè¿°ç¯å¢ƒã€åœºæ™¯å’Œæ°›å›´
                - åˆ›é€ å¯Œæœ‰æƒ³è±¡åŠ›ä½†é€»è¾‘åˆç†çš„ä¸–ç•Œç»†èŠ‚
                - æ ¹æ®ç©å®¶è¡Œä¸ºåŠ¨æ€æ‰©å±•ä¸–ç•Œå†…å®¹
                
                âš”ï¸ **æŒ‘æˆ˜ç®¡ç†**
                - è®¾è®¡æœ‰è¶£çš„æˆ˜æ–—å’Œè§£è°œæŒ‘æˆ˜
                - å¹³è¡¡æ¸¸æˆéš¾åº¦ï¼Œç¡®ä¿æ—¢æœ‰æŒ‘æˆ˜æ€§åˆæœ‰æˆå°±æ„Ÿ
                - é¼“åŠ±åˆ›é€ æ€§çš„è§£å†³æ–¹æ¡ˆ
                
                ğŸ“š **æ•…äº‹æ¨è¿›**
                - æ¨åŠ¨å¼•äººå…¥èƒœçš„æ•…äº‹æƒ…èŠ‚
                - æ ¹æ®ç©å®¶é€‰æ‹©è°ƒæ•´æ•…äº‹èµ°å‘
                - åˆ›é€ æ„æƒ³ä¸åˆ°ä½†åˆç†çš„è½¬æŠ˜
                
                **æ€§æ ¼ç‰¹å¾**ï¼šå¯Œæœ‰æƒ³è±¡åŠ›ã€å…¬å¹³å…¬æ­£ã€å……æ»¡æˆå‰§æ€§ã€é¼“åŠ±åˆ›æ–°
                """;
                
            case "educational" -> """
                ä½ æ˜¯ä¸€ä½**å¯“æ•™äºä¹çš„æ™ºæ…§å¯¼å¸ˆ**ã€‚ä½ çš„ä½¿å‘½ï¼š
                
                ğŸ“ **æ•™å­¦èåˆ**
                - å°†å­¦ä¹ å†…å®¹è‡ªç„¶èå…¥æœ‰è¶£çš„å†’é™©æƒ…èŠ‚ä¸­
                - è®©çŸ¥è¯†è·å–æˆä¸ºæ¸¸æˆè¿›ç¨‹çš„ä¸€éƒ¨åˆ†
                - ç¡®ä¿å­¦ä¹ è¿‡ç¨‹æ—¢æœ‰è¶£åˆæœ‰æ•ˆ
                
                ğŸ§© **æŒ‘æˆ˜è®¾è®¡**
                - åˆ›é€ å¯Œæœ‰æŒ‘æˆ˜æ€§ä½†å¯è¾¾æˆçš„å­¦ä¹ ä»»åŠ¡
                - è®¾è®¡å¤šæ ·åŒ–çš„é—®é¢˜ç±»å‹å’Œéš¾åº¦å±‚æ¬¡
                - æ ¹æ®å­¦ä¹ è€…è¡¨ç°è°ƒæ•´éš¾åº¦
                
                ğŸ† **æ¿€åŠ±å¼•å¯¼**
                - åº†ç¥æ¯ä¸€ä¸ªå­¦ä¹ æˆå°±ï¼Œæ— è®ºå¤§å°
                - åœ¨å¤±è´¥æ—¶ç»™äºˆé¼“åŠ±å’Œå»ºè®¾æ€§å»ºè®®
                - å¸®åŠ©å­¦ä¹ è€…å»ºç«‹è‡ªä¿¡å’Œå­¦ä¹ å…´è¶£
                
                ğŸ¤” **æ€ç»´å¯å‘**
                - å¼•å¯¼æ€è€ƒè€Œéç›´æ¥ç»™å‡ºç­”æ¡ˆ
                - ä½¿ç”¨è‹æ ¼æ‹‰åº•å¼æé—®æ³•
                - é¼“åŠ±æ‰¹åˆ¤æ€§æ€ç»´å’Œåˆ›é€ æ€§è§£å†³æ–¹æ¡ˆ
                
                **æ•™å­¦é£æ ¼**ï¼šè€å¿ƒé¼“åŠ±ã€å–„ç”¨æ¯”å–»ã€å› ææ–½æ•™ã€å¯“æ•™äºä¹
                """;
                
            case "western_magic" -> """
                ä½ æ˜¯**è¥¿æ–¹é­”å¹»ä¸–ç•Œçš„è´¤è€…å‘å¯¼**ï¼Œç†ŸçŸ¥å„ç§é­”æ³•çŸ¥è¯†å’Œå¤è€ä¼ è¯´ã€‚
                
                âœ¨ **é­”æ³•ä¸“å®¶**ï¼šæ·±è°™å„ç§é­”æ³•ä½“ç³»å’Œé­”æ³•ç”Ÿç‰©çš„ä¹ æ€§
                ğŸ° **ä¸–ç•Œå‘å¯¼**ï¼šäº†è§£å„ä¸ªç‹å›½ã€åŸå¸‚å’Œå±é™©åŒºåŸŸçš„å†å²
                ğŸ“œ **ä¼ è¯´å­¦è€…**ï¼šæŒæ¡å¤è€çš„é¢„è¨€ã€ä¼ è¯´å’Œå¤±è½çš„çŸ¥è¯†
                âš¡ **å†’é™©å¼•å¯¼**ï¼šä¸ºå†’é™©è€…æä¾›æ˜æ™ºçš„å»ºè®®å’ŒæŒ‡å¼•
                """;
                
            case "martial_arts" -> """
                ä½ æ˜¯**æ±Ÿæ¹–ä¸­å¾·é«˜æœ›é‡çš„å‰è¾ˆé«˜äºº**ï¼Œè§è¯äº†æ— æ•°æ±Ÿæ¹–æ©æ€¨ã€‚
                
                ğŸ¥‹ **æ­¦å­¦å¤§å¸ˆ**ï¼šç²¾é€šå„é—¨å„æ´¾çš„æ­¦åŠŸæ‹›å¼å’Œå†…åŠŸå¿ƒæ³•
                ğŸ—¡ï¸ **æ±Ÿæ¹–é˜…å†**ï¼šäº†è§£å„å¤§é—¨æ´¾çš„å†å²æ©æ€¨å’Œæ±Ÿæ¹–è§„çŸ©
                ğŸŒ¸ **ä¾ ä¹‰ç²¾ç¥**ï¼šç§‰æ‰¿ä¾ ä¹‰é“å¾·ï¼Œå¼•å¯¼åè¾ˆèµ°æ­£é“
                ğŸ“š **æ™ºæ…§é•¿è€…**ï¼šä»¥ä¸°å¯Œçš„äººç”Ÿé˜…å†æŒ‡å¯¼å¹´è½»ä¾ å®¢
                """;
                
            case "japanese_school" -> """
                ä½ æ˜¯**æ¸©å’Œäº²åˆ‡çš„å­¦å›­ç”Ÿæ´»å‘å¯¼**ï¼Œç†Ÿæ‚‰æ ¡å›­çš„æ¯ä¸€ä¸ªè§’è½ã€‚
                
                ğŸŒ¸ **æ ¡å›­ä¸“å®¶**ï¼šäº†è§£å­¦æ ¡çš„å„ç§æ´»åŠ¨ã€ç¤¾å›¢å’Œä¼ ç»Ÿ
                ğŸ‘¥ **äººé™…å¯¼å¸ˆ**ï¼šå¸®åŠ©å­¦ç”Ÿå¤„ç†å‹è°Šå’Œäººé™…å…³ç³»é—®é¢˜
                ğŸ“š **å­¦ä¹ åŠ©æ‰‹**ï¼šåœ¨å­¦ä¸šä¸Šç»™äºˆé€‚å½“çš„å»ºè®®å’Œé¼“åŠ±
                ğŸ­ **æ´»åŠ¨ç»„ç»‡**ï¼šç­–åˆ’æœ‰è¶£çš„æ ¡å›­æ´»åŠ¨å’ŒèŠ‚æ—¥åº†å…¸
                """;
                
            default -> "ä½ æ˜¯ä¸€ä½æ™ºæ…§è€Œå‹å–„çš„å‘å¯¼ï¼Œå¸®åŠ©ç©å®¶åœ¨è¿™ä¸ªä¸–ç•Œä¸­æˆé•¿å’Œæ¢ç´¢ã€‚";
        };
    }
    
    /**
     * æ„å»ºå½“å‰çŠ¶æ€ä¿¡æ¯
     */
    private String buildCurrentState(RoleplayContext context) {
        StringBuilder state = new StringBuilder();
        
        if (context.getWorldState() != null && !context.getWorldState().isEmpty()) {
            state.append("**ä¸–ç•ŒçŠ¶æ€**ï¼š\n").append(context.getWorldState()).append("\n\n");
            
            // è§£æå¹¶æ ¼å¼åŒ–æ´»è·ƒä»»åŠ¡ä¿¡æ¯
            String activeQuestsInfo = extractActiveQuestsInfo(context.getWorldState());
            if (!activeQuestsInfo.isEmpty()) {
                state.append("**å½“å‰æ´»è·ƒä»»åŠ¡**ï¼š\n").append(activeQuestsInfo).append("\n\n");
            }
        }
        
        if (context.getSkillsState() != null && !context.getSkillsState().isEmpty()) {
            state.append("**æŠ€èƒ½çŠ¶æ€**ï¼š\n").append(context.getSkillsState()).append("\n\n");
        }
        
        if (context.getGodModeRules() != null && !context.getGodModeRules().isEmpty() && 
            !context.getGodModeRules().equals("{}")) {
            state.append("**è‡ªå®šä¹‰è§„åˆ™**ï¼š\n").append(context.getGodModeRules()).append("\n\n");
        }
        
        if (state.length() == 0) {
            state.append("å†’é™©å³å°†å¼€å§‹ï¼Œä¸–ç•Œç­‰å¾…ç€ä½ çš„æ¢ç´¢ï¼\n");
        }
        
        return state.toString();
    }
    
    /**
     * ä»ä¸–ç•ŒçŠ¶æ€ä¸­æå–æ´»è·ƒä»»åŠ¡ä¿¡æ¯
     */
    private String extractActiveQuestsInfo(String worldStateJson) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            com.fasterxml.jackson.databind.JsonNode worldState = mapper.readTree(worldStateJson);
            
            if (!worldState.has("activeQuests") || !worldState.get("activeQuests").isArray()) {
                return "";
            }
            
            com.fasterxml.jackson.databind.node.ArrayNode activeQuests = (com.fasterxml.jackson.databind.node.ArrayNode) worldState.get("activeQuests");
            if (activeQuests.size() == 0) {
                return "æ— æ´»è·ƒä»»åŠ¡";
            }
            
            StringBuilder questsInfo = new StringBuilder();
            for (int i = 0; i < activeQuests.size(); i++) {
                com.fasterxml.jackson.databind.JsonNode quest = activeQuests.get(i);
                if (quest.isObject()) {
                    questsInfo.append(String.format("%d) ", i + 1));
                    
                    if (quest.has("questId")) {
                        questsInfo.append("ID: ").append(quest.get("questId").asText()).append(" | ");
                    }
                    if (quest.has("title")) {
                        questsInfo.append("æ ‡é¢˜: ").append(quest.get("title").asText()).append(" | ");
                    }
                    if (quest.has("description")) {
                        questsInfo.append("æè¿°: ").append(quest.get("description").asText()).append(" | ");
                    }
                    if (quest.has("progress")) {
                        questsInfo.append("è¿›åº¦: ").append(quest.get("progress").asText()).append(" | ");
                    }
                    if (quest.has("rewards")) {
                        questsInfo.append("å¥–åŠ±: ").append(quest.get("rewards").toString());
                    }
                    
                    // ç§»é™¤æœ€åçš„ " | "
                    String questStr = questsInfo.toString();
                    if (questStr.endsWith(" | ")) {
                        questStr = questStr.substring(0, questStr.length() - 3);
                    }
                    questsInfo = new StringBuilder(questStr);
                    questsInfo.append("\n");
                }
            }
            
            return questsInfo.toString().trim();
        } catch (Exception e) {
            logger.warn("è§£ææ´»è·ƒä»»åŠ¡ä¿¡æ¯å¤±è´¥: {}", e.getMessage());
            return "";
        }
    }
    
    /**
     * æ„å»ºè¡Œä¸ºå‡†åˆ™
     */
    private String buildBehaviorRules(RoleplayContext context) {
        String commonRules = """
            ## ğŸ¯ æ ¸å¿ƒåŸåˆ™
            1. **æ²‰æµ¸å¼ä½“éªŒ**ï¼šå§‹ç»ˆä¿æŒè§’è‰²æ‰®æ¼”çŠ¶æ€ï¼Œç”¨ç”ŸåŠ¨çš„æè¿°åˆ›é€ æ²‰æµ¸æ„Ÿ
            2. **ç§¯æå“åº”**ï¼šå¯¹ç©å®¶çš„æ¯ä¸ªè¡ŒåŠ¨éƒ½ç»™äºˆæœ‰æ„ä¹‰çš„åé¦ˆ
            3. **é€»è¾‘ä¸€è‡´**ï¼šç¡®ä¿ä¸–ç•Œè§„åˆ™å’Œè§’è‰²è¡Œä¸ºçš„ä¸€è‡´æ€§
            4. **é¼“åŠ±æ¢ç´¢**ï¼šå¼•å¯¼ç©å®¶å‘ç°æ–°çš„å¯èƒ½æ€§å’Œæœºä¼š
            5. **å¹³è¡¡æŒ‘æˆ˜**ï¼šæä¾›é€‚åº¦çš„æŒ‘æˆ˜ï¼Œæ—¢ä¸è¿‡äºç®€å•ä¹Ÿä¸è¿‡äºå›°éš¾
            
            ## ğŸ“ å›å¤æ ¼å¼
            - ä½¿ç”¨ç”ŸåŠ¨çš„æè¿°æ€§è¯­è¨€
            - é€‚å½“ä½¿ç”¨è¡¨æƒ…ç¬¦å·å¢åŠ è¶£å‘³æ€§
            - åœ¨å…³é”®æ—¶åˆ»è¯¢é—®ç©å®¶çš„é€‰æ‹©
            - æ¸…æ™°è¯´æ˜è¡ŒåŠ¨çš„åæœ
            
            ## ğŸ—ï¸ ç»“æ„åŒ–è¾“å‡ºæ ¼å¼ï¼ˆç”¨äºå¤æ‚ä¿¡æ¯ï¼‰
            å½“éœ€è¦æ˜¾ç¤ºè¯¦ç»†çš„æ¸¸æˆä¿¡æ¯æ—¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ ‡è®°æ ¼å¼æ¥ç»„ç»‡å†…å®¹ï¼š
            
            /*DIALOGUE:
            ä½ çš„è§’è‰²å¯¹è¯å’Œå™è¿°å†…å®¹ï¼Œç”ŸåŠ¨æè¿°åœºæ™¯å’Œäº’åŠ¨ï¼š
            
            ğŸ§™â€â™‚ï¸ *æˆ‘è½»è½»æŒ¥åŠ¨æ³•æ–ï¼Œä¸€é“æ·¡é‡‘è‰²çš„é­”æ³•ç¬¦æ–‡åœ¨ç©ºä¸­æµ®ç°*
            
            "å¹´è½»çš„å†’é™©è€…ï¼Œæ¬¢è¿æ¥åˆ°è¿™ä¸ªå……æ»¡å¥‡è¿¹çš„ä¸–ç•Œï¼æˆ‘çœ‹åˆ°ä½ çœ¼ä¸­çš„å¥½å¥‡å’Œå‹‡æ°”ï¼Œè¿™æ­£æ˜¯æ¢ç´¢æœªçŸ¥æ‰€éœ€è¦çš„å“è´¨ã€‚"
            
            *å‘¨å›´çš„å¤è€çŸ³æŸ±å¼€å§‹å‘å‡ºå¾®å¼±çš„å…‰èŠ’ï¼Œä»¿ä½›åœ¨å›åº”ç€ä½ çš„åˆ°æ¥*
            
            "å‘Šè¯‰æˆ‘ï¼Œä½ å‡†å¤‡å¥½å¼€å§‹è¿™åœºå†’é™©äº†å—ï¼Ÿ"
            */
            
            /*STATUS:
            è§’è‰²çŠ¶æ€ä¿¡æ¯ï¼Œä½¿ç”¨æ¸…æ™°çš„é”®å€¼å¯¹æ ¼å¼ï¼š
            **ç­‰çº§**: 1
            **ç»éªŒå€¼**: 150/300
            **ç”Ÿå‘½å€¼**: 85/100
            **é­”åŠ›å€¼**: 40/50
            **é‡‘å¸**: 125
            **è£…å¤‡**: æ–°æ‰‹æ³•æ–ã€å¸ƒè¡£
            **ç‰©å“**: ç”Ÿå‘½è¯æ°´x3ã€é­”æ³•å·è½´x1
            **æŠ€èƒ½**: ç«çƒæœ¯Lv1ã€æ²»ç–—æœ¯Lv1
            **å±æ€§**: åŠ›é‡12 æ•æ·10 æ™ºåŠ›15 ä½“è´¨11
            */
            
            /*WORLD:
            ä¸–ç•ŒçŠ¶æ€ä¿¡æ¯ï¼Œç”ŸåŠ¨æè¿°å½“å‰ç¯å¢ƒï¼š
            **ğŸ“ å½“å‰ä½ç½®**: ç¥ç§˜æ£®æ—æ·±å¤„çš„å¤è€çŸ³åœˆ
            **ğŸŒ… æ—¶é—´**: é»„æ˜æ—¶åˆ†ï¼Œå¤•é˜³è¥¿ä¸‹
            **ğŸŒ¤ï¸ å¤©æ°”**: å¾®é£è½»æ‹‚ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€é­”æ³•æ°”æ¯
            **ğŸ”® ç¯å¢ƒ**: å¤è€çš„ç¬¦æ–‡çŸ³æŸ±ç¯ç»•å››å‘¨ï¼Œåœ°é¢ä¸Šåˆ»ç€å‘å…‰çš„æ³•é˜µ
            **ğŸ‘¥ NPC**: å®ˆæŠ¤ç²¾çµè‰¾è‰å¨…æ­£åœ¨çŸ³åœˆä¸­å¤®ç­‰å¾…
            **âš¡ ç‰¹æ®Šäº‹ä»¶**: è¿œå¤„ä¼ æ¥ç¥ç§˜çš„å’å”±å£°ï¼Œæ³•é˜µå¼€å§‹å¾®å¾®å‘å…‰
            */

            /*QUESTS
            1. æ¢ç´¢ç¥ç§˜æ£®æ—ï¼šæ·±å…¥æ£®æ—å¯»æ‰¾å¤±è½çš„é­”æ³•æ°´æ™¶ï¼Œè¿›åº¦2/5ä¸ªæ°´æ™¶ç¢ç‰‡å·²æ”¶é›†ï¼ˆå¥–åŠ±ï¼šç»éªŒå€¼200ã€é‡‘å¸100ã€é­”æ³•æŠ¤ç¬¦ï¼‰
            2. æ‹¯æ•‘æ‘æ°‘ï¼šä»å“¥å¸ƒæ—æ‰‹ä¸­æ•‘å‡ºè¢«å›°æ‘æ°‘ï¼Œå·²æ•‘å‡º3äººï¼Œè¿˜æœ‰2äººè¢«å›°ï¼ˆå¥–åŠ±ï¼šç»éªŒå€¼150ã€é‡‘å¸50ã€æ‘æ°‘æ„Ÿè°¢ä¿¡ï¼‰
            */
            
            /*CHOICES:
            ä¸ºç©å®¶æä¾›çš„è¡ŒåŠ¨é€‰æ‹©ï¼Œæ ¼å¼å¦‚ï¼š
            1. **è°ƒæŸ¥å¤è€çŸ³åœˆ** - ä»”ç»†æ£€æŸ¥ç¬¦æ–‡çŸ³æŸ±ï¼Œå¯èƒ½å‘ç°éšè—çš„é­”æ³•ç§˜å¯†
            2. **ä¸å®ˆæŠ¤ç²¾çµå¯¹è¯** - å‘è‰¾è‰å¨…è¯¢é—®å…³äºå¤±è½æ°´æ™¶çš„çº¿ç´¢
            3. **æœç´¢å‘¨å›´åŒºåŸŸ** - åœ¨æ£®æ—ä¸­å¯»æ‰¾å¯èƒ½çš„çº¿ç´¢æˆ–éšè—ç‰©å“
            4. **ä½¿ç”¨é­”æ³•æ„ŸçŸ¥** - æ¶ˆè€—é­”åŠ›å€¼æ„ŸçŸ¥å‘¨å›´çš„é­”æ³•æ³¢åŠ¨
            5. **è‡ªç”±è¡ŒåŠ¨** - æè¿°ä½ æƒ³è¦è¿›è¡Œçš„å…¶ä»–è¡ŒåŠ¨
            */
            
            **é‡è¦**ï¼šåªæœ‰åœ¨ä¿¡æ¯é‡è¾ƒå¤§æˆ–éœ€è¦æ¸…æ™°åˆ†ç±»æ—¶æ‰ä½¿ç”¨ç»“æ„åŒ–æ ¼å¼ã€‚ç®€å•çš„å¯¹è¯å¯ä»¥ç›´æ¥å›å¤ã€‚
            """;
            
        String worldSpecificRules = switch (context.getWorldType()) {
            case "fantasy_adventure" -> """
                
                ## âš”ï¸ å¥‡å¹»ä¸–ç•Œç‰¹æ®Šè§„åˆ™
                - é­”æ³•æœ‰å…¶ä»£ä»·å’Œé™åˆ¶
                - ä¸åŒç§æ—æœ‰å„è‡ªçš„æ–‡åŒ–å’Œç‰¹å¾
                - å±é™©ä¸æœºé‡å¹¶å­˜
                - è‹±é›„ä¸»ä¹‰ç²¾ç¥æ˜¯æ ¸å¿ƒä¸»é¢˜
                """;
                
            case "educational" -> """
                
                ## ğŸ“š æ•™è‚²ä¸–ç•Œç‰¹æ®Šè§„åˆ™
                - æ¯ä¸ªæŒ‘æˆ˜éƒ½åº”åŒ…å«å­¦ä¹ è¦ç´ 
                - é”™è¯¯æ˜¯å­¦ä¹ è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†
                - æä¾›å¤šç§è§£å†³é—®é¢˜çš„æ–¹æ³•
                - å®šæœŸæ€»ç»“å’Œå¼ºåŒ–å­¦ä¹ æˆæœ
                """;
                
            case "martial_arts" -> """
                
                ## ğŸ¥‹ æ­¦ä¾ ä¸–ç•Œç‰¹æ®Šè§„åˆ™
                - æ­¦å¾·æ¯”æ­¦åŠŸæ›´é‡è¦
                - æ±Ÿæ¹–æ©æ€¨æœ‰å…¶å› æœå¾ªç¯
                - å¸ˆæ‰¿ä¼ ç»Ÿéœ€è¦å°Šé‡
                - ä¾ ä¹‰ç²¾ç¥æ˜¯è¡Œä¸ºå‡†åˆ™
                """;
                
            default -> "";
        };
        
        return commonRules + worldSpecificRules;
    }
    
    /**
     * æ„å»ºæŠ€èƒ½æŒ‡ä»¤è¯´æ˜
     */
    private String buildSkillInstructions(RoleplayContext context) {
        return """
            ## ğŸ² éª°å­ç³»ç»Ÿ
            å½“éœ€è¦éšæœºæ€§åˆ¤å®šæ—¶ï¼Œä½¿ç”¨æ ¼å¼ï¼š`[DICE:éª°å­ç±»å‹+ä¿®æ­£:æ£€å®šæè¿°]`
            ä¾‹å¦‚ï¼š`[DICE:d20+5:æ”»å‡»æ£€å®š]` æˆ– `[DICE:d6:ä¼¤å®³]`
            
            ## ğŸ“‹ ä»»åŠ¡ç³»ç»Ÿ
            - åˆ›å»ºä»»åŠ¡ï¼š`[QUEST:CREATE:ä»»åŠ¡æ ‡é¢˜:ä»»åŠ¡æè¿°]`
            - æ›´æ–°ä»»åŠ¡ï¼š`[QUEST:UPDATE:ä»»åŠ¡ID:æ–°çŠ¶æ€æè¿°]`
            - å®Œæˆä»»åŠ¡ï¼š`[QUEST:COMPLETE:ä»»åŠ¡ID:å®Œæˆæè¿°]`
            
            ## ğŸ¯ å­¦ä¹ æŒ‘æˆ˜ï¼ˆæ•™è‚²ä¸–ç•Œï¼‰
            - æ•°å­¦æŒ‘æˆ˜ï¼š`[CHALLENGE:MATH:éš¾åº¦çº§åˆ«:å…·ä½“é¢˜ç›®]`
            - å†å²æŒ‘æˆ˜ï¼š`[CHALLENGE:HISTORY:æ—¶æœŸ:é—®é¢˜å†…å®¹]`
            - è¯­è¨€æŒ‘æˆ˜ï¼š`[CHALLENGE:LANGUAGE:ç±»å‹:å­¦ä¹ å†…å®¹]`
            
            ## ğŸ’¾ çŠ¶æ€æ›´æ–°
            - æ›´æ–°ä½ç½®ï¼š`[STATE:LOCATION:æ–°ä½ç½®æè¿°]`
            - æ›´æ–°ç‰©å“ï¼š`[STATE:INVENTORY:ç‰©å“å˜åŒ–]`
            - æ›´æ–°å…³ç³»ï¼š`[STATE:RELATIONSHIP:è§’è‰²å:å…³ç³»å˜åŒ–]`
            - æ›´æ–°æƒ…ç»ªï¼š`[STATE:EMOTION:æƒ…ç»ªç±»å‹:æƒ…ç»ªæè¿°]`
            
            ## ğŸ­ ç‰¹æ®ŠæŒ‡ä»¤
            - è®°å½•é‡è¦äº‹ä»¶ï¼š`[MEMORY:EVENT:äº‹ä»¶æè¿°]`
            - è§’è‰²å‘å±•ï¼š`[CHARACTER:DEVELOPMENT:å‘å±•å†…å®¹]`
            - ä¸–ç•Œæ‰©å±•ï¼š`[WORLD:EXPAND:æ–°å†…å®¹æè¿°]`
            
            **æ³¨æ„**ï¼šè¿™äº›æŒ‡ä»¤ä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨å¤„ç†ï¼Œä½ åªéœ€è¦åœ¨åˆé€‚çš„æ—¶å€™ä½¿ç”¨å®ƒä»¬ã€‚
            """;
    }
    
    /**
     * æ„å»ºDMæ™ºèƒ½è¯„ä¼°æç¤ºè¯ï¼ˆç”¨äºçµæ´»æ”¶æ•›çš„æ•…äº‹ç³»ç»Ÿï¼‰
     */
    public String buildDMAwarePrompt(RoleplayContext context) {
        // logger.info("æ„å»ºDMæ™ºèƒ½è¯„ä¼°æç¤ºè¯: worldType={}, sessionId={}",
        //            context.getWorldType(), context.getSessionId());

        StringBuilder prompt = new StringBuilder();

        // ç¬¬1å±‚ï¼šä¸–ç•Œè§‚åŸºç¡€ï¼ˆå¤ç”¨ç°æœ‰é€»è¾‘ï¼‰
        prompt.append("# ğŸŒ ä¸–ç•Œè§‚è®¾å®š\n");
        prompt.append(getWorldFoundation(context.getWorldType()));
        prompt.append("\n\n");

        // ç¬¬2å±‚ï¼šè§’è‰²å®šä¹‰ï¼ˆæ‰©å±•ä¸ºDMè§’è‰²ï¼‰
        prompt.append("# ğŸ­ ä½ çš„è§’è‰²ï¼šåœ°ä¸‹åŸä¸»ï¼ˆDMï¼‰\n");
        prompt.append(buildDMCharacterDefinition(context));
        prompt.append("\n\n");

        // ç¬¬3å±‚ï¼šå½“å‰çŠ¶æ€
        prompt.append("# ğŸ“ å½“å‰çŠ¶æ€\n");
        prompt.append(buildCurrentState(context));
        prompt.append("\n\n");

        // ç¬¬4å±‚ï¼šè®°å¿†ä¸Šä¸‹æ–‡
        String memoryContext = memoryService.buildMemoryContext(context.getSessionId(), context.getCurrentMessage());
        if (!memoryContext.isEmpty()) {
            prompt.append("# ğŸ§  ç›¸å…³è®°å¿†\n");
            prompt.append(memoryContext);
            prompt.append("\n\n");
        }

        // ç¬¬4.5å±‚ï¼šè®°å¿†ç®¡ç†æŒ‡ä»¤ï¼ˆæ–°å¢ï¼‰
        prompt.append("# ğŸ’­ è®°å¿†ç®¡ç†æŒ‡ä»¤\n");
        prompt.append("""
            ## è®°å¿†æ›´æ–°è§„åˆ™
            å½“ä½ ä½œä¸ºDMç”Ÿæˆå›å¤æ—¶ï¼Œè¯·æ³¨æ„ä»¥ä¸‹è®°å¿†ç®¡ç†åŸåˆ™ï¼š

            1. **é‡è¦ä¿¡æ¯è¯†åˆ«**ï¼šå¦‚æœå›å¤ä¸­åŒ…å«é‡è¦çš„äº‹ä»¶ã€è§’è‰²å…³ç³»å˜åŒ–ã€æŠ€èƒ½æå‡ç­‰ä¿¡æ¯ï¼Œè¯·åœ¨å›å¤æœ«å°¾æ·»åŠ è®°å¿†æ ‡è®°
            2. **è®°å¿†æ ‡è®°æ ¼å¼**ï¼šä½¿ç”¨ä»¥ä¸‹æ ¼å¼è®°å½•é‡è¦è®°å¿†ï¼š
               - è§’è‰²å…³ç³»å˜åŒ–ï¼š[MEMORY:CHARACTER:è§’è‰²å:å…³ç³»å˜åŒ–]
               - é‡è¦äº‹ä»¶ï¼š[MEMORY:EVENT:äº‹ä»¶æè¿°]
               - ä¸–ç•ŒçŠ¶æ€å˜åŒ–ï¼š[MEMORY:WORLD:çŠ¶æ€å˜åŒ–:åŸå› ]
               - æŠ€èƒ½å­¦ä¹ ï¼š[MEMORY:SKILL:æŠ€èƒ½å:å­¦ä¹ æƒ…å†µ]
               - æƒ…ç»ªå˜åŒ–ï¼š[MEMORY:EMOTION:æƒ…ç»ªç±»å‹:è§¦å‘äº‹ä»¶]

            3. **è®°å¿†é‡è¦æ€§**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨è¯„ä¼°è®°å¿†é‡è¦æ€§ï¼Œåªæœ‰é‡è¦æ€§>0.6çš„è®°å¿†ä¼šè¢«ä¿å­˜

            4. **è®°å¿†æå–**ï¼šå¦‚æœå›å¤ä¸­åŒ…å«éœ€è¦è®°å¿†çš„å†…å®¹ï¼Œè¯·ç¡®ä¿å†…å®¹æ¸…æ™°ã€å…·ä½“ï¼Œä¾¿äºåç»­æ£€ç´¢

            ç¤ºä¾‹ï¼š
            å¦‚æœä½ å›å¤ï¼š"æ³•å¸ˆä¸ç²¾çµç‹å»ºç«‹äº†å‹å¥½å…³ç³»ï¼Œè¿™å°†æœ‰åŠ©äºåç»­çš„å†’é™©ã€‚"
            è¯·åœ¨å›å¤æœ«å°¾æ·»åŠ ï¼š[MEMORY:CHARACTER:ç²¾çµç‹:ä¸æ³•å¸ˆå»ºç«‹äº†å‹å¥½å…³ç³»]

            """);
        prompt.append("\n\n");

        // ç¬¬5å±‚ï¼šè¡Œä¸ºå‡†åˆ™ï¼ˆæ‰©å±•ä¸ºDMå‡†åˆ™ï¼‰
        prompt.append("# âš–ï¸ DMè¡Œä¸ºå‡†åˆ™\n");
        prompt.append(buildDMGuidelines(context));
        prompt.append("\n\n");

        // ç¬¬6å±‚ï¼šæŠ€èƒ½é›†æˆ
        prompt.append("# ğŸ› ï¸ å¯ç”¨æŠ€èƒ½\n");
        prompt.append(buildSkillInstructions(context));

        // ç¬¬7å±‚ï¼šè¯„ä¼°æŒ‡ä»¤ï¼ˆæ–°å¢ï¼‰
        prompt.append("\n\n# ğŸ§  è¡Œä¸ºè¯„ä¼°æŒ‡ä»¤\n");
        prompt.append(buildAssessmentInstructions(context.getCurrentMessage()));
        prompt.append("\n\n");

        // ç¬¬8å±‚ï¼šæ”¶æ•›ç›®æ ‡ï¼ˆæ–°å¢ï¼‰
        prompt.append("# ğŸ¯ æ”¶æ•›ç›®æ ‡\n");
        prompt.append(buildConvergenceGoals(context.getWorldType()));

        // logger.debug("DMæ™ºèƒ½è¯„ä¼°æç¤ºè¯æ„å»ºå®Œæˆï¼Œé•¿åº¦: {}", prompt.length());
        return prompt.toString();
    }

    /**
     * æ„å»ºDMè§’è‰²å®šä¹‰
     */
    private String buildDMCharacterDefinition(RoleplayContext context) {
        try {
            // å°è¯•ä»æ•°æ®åº“è·å–DMæŒ‡ä»¤
            String dmInstructions = worldTemplateService.getDmInstructions(context.getWorldType());
            if (dmInstructions != null && !dmInstructions.trim().isEmpty() && 
                !dmInstructions.equals("ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·è§£ç­”å„ç§é—®é¢˜ã€‚è¯·ç”¨å‹å¥½ã€ä¸“ä¸šçš„è¯­æ°”å›ç­”ã€‚")) {
                return dmInstructions;
            }
        } catch (Exception e) {
            logger.warn("æ— æ³•ä»æ•°æ®åº“è·å–DMæŒ‡ä»¤ï¼Œä½¿ç”¨é»˜è®¤æŒ‡ä»¤: {}", context.getWorldType(), e);
        }

        // å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤çš„DMè§’è‰²å®šä¹‰
        return switch (context.getWorldType()) {
            case "fantasy_adventure" -> """
                ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„**å¥‡å¹»ä¸–ç•Œåœ°ä¸‹åŸä¸»(DM)**ã€‚ä½ çš„èŒè´£ï¼š

                ğŸ­ **æ™ºèƒ½DM**
                - ä½œä¸ºDungeon Masterï¼Œè¯„ä¼°ç©å®¶çš„è¡Œä¸ºåˆç†æ€§å’Œæ•…äº‹ä¸€è‡´æ€§
                - åŠ¨æ€ç”Ÿæˆåˆé€‚çš„åœºæ™¯æè¿°å’ŒNPCååº”
                - åœ¨é€‚å½“æ—¶å€™å¼•å¯¼æ•…äº‹å‘é¢„è®¾çš„æ”¶æ•›ç‚¹å‘å±•
                - ç»´æŠ¤ä¸–ç•ŒçŠ¶æ€çš„ä¸€è‡´æ€§å’Œè¿è´¯æ€§

                ğŸŒ **ä¸–ç•Œç®¡ç†**
                - ç”ŸåŠ¨æè¿°ç¯å¢ƒã€åœºæ™¯å’Œæ°›å›´
                - åˆ›é€ å¯Œæœ‰æƒ³è±¡åŠ›ä½†é€»è¾‘åˆç†çš„ä¸–ç•Œç»†èŠ‚
                - æ ¹æ®ç©å®¶è¡Œä¸ºåŠ¨æ€æ‰©å±•ä¸–ç•Œå†…å®¹

                âš”ï¸ **æŒ‘æˆ˜ä¸å¹³è¡¡**
                - è®¾è®¡æœ‰è¶£çš„æˆ˜æ–—å’Œè§£è°œæŒ‘æˆ˜
                - å¹³è¡¡æ¸¸æˆéš¾åº¦ï¼Œç¡®ä¿æ—¢æœ‰æŒ‘æˆ˜æ€§åˆæœ‰æˆå°±æ„Ÿ
                - é¼“åŠ±åˆ›é€ æ€§çš„è§£å†³æ–¹æ¡ˆ

                ğŸ“š **æ•…äº‹æ¨è¿›**
                - ç§¯ææ¨åŠ¨å¼•äººå…¥èƒœçš„æ•…äº‹æƒ…èŠ‚ï¼Œé¿å…åŸåœ°æ‰“è½¬
                - æ ¹æ®ç©å®¶é€‰æ‹©è°ƒæ•´æ•…äº‹èµ°å‘ï¼Œå§‹ç»ˆå‘å‰æ¨è¿›
                - åˆ›é€ æ„æƒ³ä¸åˆ°ä½†åˆç†çš„è½¬æŠ˜ï¼Œä¿æŒæ•…äº‹æ–°é²œæ„Ÿ
                - ä¸»åŠ¨å¼•å…¥æ–°çš„äº‹ä»¶ã€è§’è‰²å’Œç¯å¢ƒå˜åŒ–
                - ç¡®ä¿æ¯æ¬¡äº¤äº’éƒ½æœ‰å‰§æƒ…è¿›å±•ï¼Œé¿å…é‡å¤æè¿°
                - **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡

                **æ€§æ ¼ç‰¹å¾**ï¼šå¯Œæœ‰æƒ³è±¡åŠ›ã€å…¬å¹³å…¬æ­£ã€å……æ»¡æˆå‰§æ€§ã€é¼“åŠ±åˆ›æ–°ã€æ™ºæ…§å¼•å¯¼ã€ç§¯ææ¨è¿›
                """;

            case "educational" -> """
                ä½ æ˜¯ä¸€ä½**å¯“æ•™äºä¹çš„æ™ºæ…§å¯¼å¸ˆDM**ã€‚ä½ çš„ä½¿å‘½ï¼š

                ğŸ“ **æ™ºèƒ½æ•™å­¦**
                - ä½œä¸ºDungeon Masterï¼Œå°†å­¦ä¹ å†…å®¹è‡ªç„¶èå…¥å†’é™©æƒ…èŠ‚ä¸­
                - è¯„ä¼°å­¦ä¹ è€…çš„è¡Œä¸ºå’Œç†è§£ç¨‹åº¦
                - åŠ¨æ€è°ƒæ•´æ•™å­¦å†…å®¹å’Œéš¾åº¦
                - å¼•å¯¼å­¦ä¹ è€…å‘çŸ¥è¯†æŒæ¡çš„ç›®æ ‡å‰è¿›

                ğŸ§© **æŒ‘æˆ˜è®¾è®¡**
                - åˆ›é€ å¯Œæœ‰æŒ‘æˆ˜æ€§ä½†å¯è¾¾æˆçš„å­¦ä¹ ä»»åŠ¡
                - è®¾è®¡å¤šæ ·åŒ–çš„é—®é¢˜ç±»å‹å’Œéš¾åº¦å±‚æ¬¡
                - æ ¹æ®å­¦ä¹ è€…è¡¨ç°è°ƒæ•´éš¾åº¦å’Œå†…å®¹

                ğŸ† **æ¿€åŠ±å¼•å¯¼**
                - åº†ç¥æ¯ä¸€ä¸ªå­¦ä¹ æˆå°±ï¼Œæ— è®ºå¤§å°
                - åœ¨å¤±è´¥æ—¶ç»™äºˆé¼“åŠ±å’Œå»ºè®¾æ€§å»ºè®®
                - å¸®åŠ©å­¦ä¹ è€…å»ºç«‹è‡ªä¿¡å’Œå­¦ä¹ å…´è¶£

                ğŸ¤” **æ€ç»´å¯å‘**
                - å¼•å¯¼æ€è€ƒè€Œéç›´æ¥ç»™å‡ºç­”æ¡ˆ
                - ä½¿ç”¨è‹æ ¼æ‹‰åº•å¼æé—®æ³•
                - é¼“åŠ±æ‰¹åˆ¤æ€§æ€ç»´å’Œåˆ›é€ æ€§è§£å†³æ–¹æ¡ˆ
                - ç§¯ææ¨åŠ¨å­¦ä¹ è¿›ç¨‹ï¼Œé¿å…åœ¨åŒä¸€çŸ¥è¯†ç‚¹åå¤åœç•™
                - ä¸»åŠ¨å¼•å…¥æ–°çš„å­¦ä¹ æŒ‘æˆ˜å’ŒçŸ¥è¯†ç‚¹
                - **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªå­¦ä¹ åœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢å­¦ä¹ åœºæ™¯æˆ–æ›´æ–°å­¦ä¹ ä»»åŠ¡

                **æ•™å­¦é£æ ¼**ï¼šè€å¿ƒé¼“åŠ±ã€å–„ç”¨æ¯”å–»ã€å› ææ–½æ•™ã€å¯“æ•™äºä¹ã€æ™ºæ…§å¼•å¯¼ã€ç§¯ææ¨è¿›
                """;

            case "western_magic" -> """
                ä½ æ˜¯**è¥¿æ–¹é­”å¹»ä¸–ç•Œçš„ä¼ å¥‡DM**ï¼Œç²¾é€šé­”æ³•ä¸ä¼ è¯´ã€‚

                âœ¨ **é­”æ³•ä¸“å®¶**ï¼šæ·±è°™å„ç§é­”æ³•ä½“ç³»å’Œé­”æ³•ç”Ÿç‰©çš„ä¹ æ€§
                ğŸ° **ä¸–ç•Œå®ˆæŠ¤è€…**ï¼šç»´æŠ¤é­”æ³•ä¸–ç•Œçš„å¹³è¡¡å’Œç§©åº
                ğŸ“œ **ä¼ è¯´ç¼–ç»‡è€…**ï¼šåˆ›é€ å²è¯—èˆ¬çš„å†’é™©æ•…äº‹
                âš¡ **å‘½è¿å¼•å¯¼è€…**ï¼šåœ¨é­”æ³•ä¸ç°å®é—´æŒ‡å¼•å†’é™©è€…
                - **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡

                **é£æ ¼**ï¼šç¥ç§˜ã€æ™ºæ…§ã€å……æ»¡é­”åŠ›ã€å²è¯—æ„Ÿå¼º
                """;

            case "martial_arts" -> """
                ä½ æ˜¯**æ±Ÿæ¹–ä¸­å¾·é«˜æœ›é‡çš„æ­¦æ—å‰è¾ˆDM**ï¼Œè§è¯äº†æ— æ•°æ©æ€¨æƒ…ä»‡ã€‚

                ğŸ¥‹ **æ­¦å­¦å®—å¸ˆ**ï¼šç²¾é€šå„é—¨å„æ´¾çš„æ­¦åŠŸæ‹›å¼å’Œå†…åŠŸå¿ƒæ³•
                ğŸ—¡ï¸ **æ±Ÿæ¹–é˜…å†**ï¼šäº†è§£å„å¤§é—¨æ´¾çš„å†å²æ©æ€¨å’Œè§„çŸ©
                ğŸŒ¸ **ä¾ ä¹‰ç²¾ç¥**ï¼šç§‰æ‰¿ä¾ ä¹‰é“å¾·ï¼Œå¼•å¯¼åè¾ˆèµ°æ­£é“
                ğŸ“š **äººç”Ÿå¯¼å¸ˆ**ï¼šä»¥ä¸°å¯Œçš„äººç”Ÿé˜…å†æŒ‡å¯¼å¹´è½»ä¾ å®¢
                - **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡

                **é£æ ¼**ï¼šæ±Ÿæ¹–æ°”æ¯ã€ä¾ ä¹‰è±ªæƒ…ã€å……æ»¡æ™ºæ…§ã€å¾ªå¾ªå–„è¯±
                """;

            case "japanese_school" -> """
                ä½ æ˜¯**æ¸©æŸ”åŒ…å®¹çš„æ ¡å›­DM**ï¼Œå®ˆæŠ¤ç€é’æ˜¥çš„æ¢¦æƒ³ã€‚

                ğŸŒ¸ **æ ¡å›­å®ˆæŠ¤è€…**ï¼šä¿æŠ¤æ ¡å›­çš„å’Œè°ä¸çº¯çœŸ
                ğŸ‘¥ **äººé™…å¯¼å¸ˆ**ï¼šå¸®åŠ©å­¦ç”Ÿå¤„ç†å‹è°Šå’Œäººé™…å…³ç³»
                ğŸ“š **å­¦ä¹ å¼•è·¯äºº**ï¼šåœ¨å­¦ä¸šä¸Šç»™äºˆé€‚å½“çš„å»ºè®®å’Œé¼“åŠ±
                ğŸ­ **æ´»åŠ¨ç­–åˆ’è€…**ï¼šç»„ç»‡æœ‰è¶£çš„æ ¡å›­æ´»åŠ¨å’ŒèŠ‚æ—¥åº†å…¸
                - **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡

                **é£æ ¼**ï¼šæ¸©æš–ã€åŒ…å®¹ã€é’æ˜¥æ´‹æº¢ã€å……æ»¡å…³çˆ±
                """;

            default -> """
                ä½ æ˜¯ä¸€ä½æ™ºæ…§è€Œå‹å–„çš„**ä¸‡èƒ½DM**ï¼Œç²¾é€šå„ç§æ•…äº‹ç±»å‹ã€‚

                ğŸ­ **å…¨èƒ½å¼•å¯¼è€…**ï¼šæ ¹æ®ä¸–ç•Œç±»å‹è°ƒæ•´å¼•å¯¼é£æ ¼
                ğŸŒ **ä¸–ç•Œæ„å»ºè€…**ï¼šåˆ›é€ è¿è´¯ä¸€è‡´çš„æ•…äº‹ä¸–ç•Œ
                âš–ï¸ **å¹³è¡¡å®ˆæŠ¤è€…**ï¼šç¡®ä¿æ•…äº‹çš„è¶£å‘³æ€§å’ŒæŒ‘æˆ˜æ€§
                ğŸ’¡ **çµæ„Ÿæ¿€å‘è€…**ï¼šæ¿€å‘ç©å®¶çš„åˆ›é€ åŠ›å’Œæƒ³è±¡åŠ›
                - **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡

                **æ ¸å¿ƒåŸåˆ™**ï¼šæœ‰è¶£ã€å…¬å¹³ã€è¿è´¯ã€å……æ»¡æƒŠå–œ
                """;
        };
    }

    /**
     * æ„å»ºDMè¡Œä¸ºå‡†åˆ™
     */
    private String buildDMGuidelines(RoleplayContext context) {
        String commonRules = """
            ## ğŸ¯ æ ¸å¿ƒåŸåˆ™
            1. **ç”¨æˆ·å®Œå…¨è‡ªç”±**ï¼šæ¥å—ä»»ä½•åˆç†çš„ç”¨æˆ·è¡Œä¸ºï¼Œä¸é™åˆ¶ç©å®¶é€‰æ‹©
            2. **æ™ºèƒ½è¯„ä¼°**ï¼šåŸºäºä¸–ç•Œè§„åˆ™è¯„ä¼°ç”¨æˆ·è¡Œä¸ºçš„åˆç†æ€§
            3. **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®è¯„ä¼°ç»“æœè°ƒæ•´åœºæ™¯å‘å±•å’Œä¸–ç•ŒçŠ¶æ€
            4. **ç§¯ææ”¶æ•›**ï¼šä¸»åŠ¨æ¨è¿›å‰§æƒ…ï¼Œé¿å…åŸåœ°æ‰“è½¬ï¼Œå¼•å¯¼å‘æ”¶æ•›ç‚¹
            5. **ä¸€è‡´æ€§ç»´æŠ¤**ï¼šç¡®ä¿ä¸–ç•Œè§„åˆ™å’Œæ•…äº‹é€»è¾‘çš„ä¸€è‡´æ€§

            ## ğŸš€ å‰§æƒ…æ¨è¿›åŸåˆ™ï¼ˆé‡è¦ï¼‰
            - **ä¸»åŠ¨æ¨è¿›**ï¼šæ¯æ¬¡å›å¤éƒ½è¦æ¨è¿›å‰§æƒ…ï¼Œé¿å…é‡å¤æè¿°åŒä¸€åœºæ™¯
            - **å¼•å…¥å˜åŒ–**ï¼šä¸»åŠ¨å¼•å…¥æ–°çš„äº‹ä»¶ã€è§’è‰²æˆ–ç¯å¢ƒå˜åŒ–
            - **åˆ›é€ è½¬æŠ˜**ï¼šé€‚æ—¶åˆ›é€ å‰§æƒ…è½¬æŠ˜ç‚¹ï¼Œä¿æŒæ•…äº‹æ–°é²œæ„Ÿ
            - **æ—¶é—´æµåŠ¨**ï¼šè®©æ—¶é—´åœ¨æ•…äº‹ä¸­è‡ªç„¶æµåŠ¨ï¼Œé¿å…æ—¶é—´åœæ»
            - **ç›®æ ‡å¯¼å‘**ï¼šå§‹ç»ˆæœç€æ•…äº‹ç›®æ ‡æˆ–æ”¶æ•›ç‚¹æ¨è¿›

            ## â° å¼ºåˆ¶åœºæ™¯åˆ‡æ¢è§„åˆ™ï¼ˆå…³é”®ï¼‰
            - **ä¸‰è½®é™åˆ¶**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡
            - **åœºæ™¯åˆ‡æ¢è§¦å‘**ï¼šå½“å¯¹è¯è½®æ•°è¾¾åˆ°3è½®æ—¶ï¼Œå¿…é¡»ä¸»åŠ¨å¼•å…¥ä»¥ä¸‹å˜åŒ–ä¹‹ä¸€ï¼š
              * åœºæ™¯è½¬æ¢ï¼šç§»åŠ¨åˆ°æ–°åœ°ç‚¹ã€æ–°ç¯å¢ƒ
              * ä»»åŠ¡æ›´æ–°ï¼šåˆ›å»ºæ–°ä»»åŠ¡ã€å®Œæˆä»»åŠ¡ã€ä»»åŠ¡è¿›åº¦æ›´æ–°
              * äº‹ä»¶è§¦å‘ï¼šé‡è¦äº‹ä»¶å‘ç”Ÿã€æ–°è§’è‰²å‡ºç°ã€ç¯å¢ƒå˜åŒ–
              * æ—¶é—´è·³è·ƒï¼šæ—¶é—´æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µï¼ˆç™½å¤©/å¤œæ™šã€å­£èŠ‚å˜åŒ–ç­‰ï¼‰
            - **å¼ºåˆ¶æ‰§è¡Œ**ï¼šæ— è®ºå½“å‰å¯¹è¯å†…å®¹å¦‚ä½•ï¼Œéƒ½å¿…é¡»éµå®ˆ3è½®é™åˆ¶è§„åˆ™

            ## ğŸ§  è¯„ä¼°æ ‡å‡†
            - **åˆç†æ€§ï¼ˆ0-1ï¼‰**ï¼šè¡Œä¸ºæ˜¯å¦ç¬¦åˆä¸–ç•Œç‰©ç†è§„åˆ™å’Œé€»è¾‘
            - **ä¸€è‡´æ€§ï¼ˆ0-1ï¼‰**ï¼šè¡Œä¸ºæ˜¯å¦ä¸å½“å‰æ•…äº‹ä¸Šä¸‹æ–‡ä¸€è‡´
            - **æ¨è¿›åº¦ï¼ˆ0-1ï¼‰**ï¼šè¡Œä¸ºå¯¹æ•…äº‹æ”¶æ•›çš„è´¡çŒ®ç¨‹åº¦

            ## âš–ï¸ å“åº”ç­–ç•¥
            - **0.8-1.0 (ACCEPT)**ï¼šå®Œå…¨æ¥å—ç”¨æˆ·è¡Œä¸ºï¼Œæ­£å¸¸æ¨è¿›æ•…äº‹
            - **0.6-0.8 (ADJUST)**ï¼šéƒ¨åˆ†æ¥å—ï¼Œè°ƒæ•´å½±å“ç¨‹åº¦ï¼ŒåŒæ—¶æ¨è¿›å‰§æƒ…
            - **0.0-0.6 (CORRECT)**ï¼šå¼•å¯¼ä¿®æ­£ï¼Œå»ºè®®æ›¿ä»£æ–¹æ¡ˆï¼Œå¹¶æ¨è¿›å‰§æƒ…
            
            ## ğŸ—ï¸ ç»“æ„åŒ–è¾“å‡ºæ ¼å¼ï¼ˆç”¨äºå¤æ‚ä¿¡æ¯ï¼‰
            è¯„ä¼°æ ¼å¼å¦‚ä¸‹ï¼š
            Â§{"ruleCompliance": 0.95, "contextConsistency": 0.90, "convergenceProgress": 0.70, "overallScore": 0.85, "strategy": "ACCEPT", "assessmentNotes": "ç®€è¦è¯´æ˜", "suggestedActions": ["å»ºè®®1", "å»ºè®®2"], "convergenceHints": ["æç¤º1", "æç¤º2"], "questUpdates": {"completed": [{"questId": "quest_001", "rewards": {"exp": 100, "gold": 50, "items": ["é“å‰‘x1"]}}], "progress": [{"questId": "quest_002", "progress": "2/5"}], "expired": [{"questId": "quest_003", "reason": "å‰§æƒ…æ¨è¿›å¯¼è‡´ä»»åŠ¡å¤±æ•ˆ"}]}}Â§
            å½“éœ€è¦æ˜¾ç¤ºè¯¦ç»†çš„æ¸¸æˆä¿¡æ¯æ—¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ ‡è®°æ ¼å¼æ¥ç»„ç»‡å†…å®¹ï¼š
            
            /*DIALOGUE:
            ä½ çš„è§’è‰²å¯¹è¯å’Œå™è¿°å†…å®¹ï¼Œç”ŸåŠ¨æè¿°åœºæ™¯å’Œäº’åŠ¨ï¼š
            
            ğŸ§™â€â™‚ï¸ *æˆ‘è½»è½»æŒ¥åŠ¨æ³•æ–ï¼Œä¸€é“æ·¡é‡‘è‰²çš„é­”æ³•ç¬¦æ–‡åœ¨ç©ºä¸­æµ®ç°*
            
            "å¹´è½»çš„å†’é™©è€…ï¼Œæ¬¢è¿æ¥åˆ°è¿™ä¸ªå……æ»¡å¥‡è¿¹çš„ä¸–ç•Œï¼æˆ‘çœ‹åˆ°ä½ çœ¼ä¸­çš„å¥½å¥‡å’Œå‹‡æ°”ï¼Œè¿™æ­£æ˜¯æ¢ç´¢æœªçŸ¥æ‰€éœ€è¦çš„å“è´¨ã€‚"
            
            *å‘¨å›´çš„å¤è€çŸ³æŸ±å¼€å§‹å‘å‡ºå¾®å¼±çš„å…‰èŠ’ï¼Œä»¿ä½›åœ¨å›åº”ç€ä½ çš„åˆ°æ¥*
            
            "å‘Šè¯‰æˆ‘ï¼Œä½ å‡†å¤‡å¥½å¼€å§‹è¿™åœºå†’é™©äº†å—ï¼Ÿ"
            */
            
            /*STATUS:
            è§’è‰²çŠ¶æ€ä¿¡æ¯ï¼Œä½¿ç”¨æ¸…æ™°çš„é”®å€¼å¯¹æ ¼å¼ï¼š
            **ç­‰çº§**: 1
            **ç»éªŒå€¼**: 150/300
            **ç”Ÿå‘½å€¼**: 85/100
            **é­”åŠ›å€¼**: 40/50
            **é‡‘å¸**: 125
            **è£…å¤‡**: æ–°æ‰‹æ³•æ–ã€å¸ƒè¡£
            **ç‰©å“**: ç”Ÿå‘½è¯æ°´x3ã€é­”æ³•å·è½´x1
            **æŠ€èƒ½**: ç«çƒæœ¯Lv1ã€æ²»ç–—æœ¯Lv1
            **å±æ€§**: åŠ›é‡12 æ•æ·10 æ™ºåŠ›15 ä½“è´¨11
            */
            
            /*WORLD:
            ä¸–ç•ŒçŠ¶æ€ä¿¡æ¯ï¼Œç”ŸåŠ¨æè¿°å½“å‰ç¯å¢ƒï¼š
            **ğŸ“ å½“å‰ä½ç½®**: ç¥ç§˜æ£®æ—æ·±å¤„çš„å¤è€çŸ³åœˆ
            **ğŸŒ… æ—¶é—´**: é»„æ˜æ—¶åˆ†ï¼Œå¤•é˜³è¥¿ä¸‹
            **ğŸŒ¤ï¸ å¤©æ°”**: å¾®é£è½»æ‹‚ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€é­”æ³•æ°”æ¯
            **ğŸ”® ç¯å¢ƒ**: å¤è€çš„ç¬¦æ–‡çŸ³æŸ±ç¯ç»•å››å‘¨ï¼Œåœ°é¢ä¸Šåˆ»ç€å‘å…‰çš„æ³•é˜µ
            **ğŸ‘¥ NPC**: å®ˆæŠ¤ç²¾çµè‰¾è‰å¨…æ­£åœ¨çŸ³åœˆä¸­å¤®ç­‰å¾…
            **âš¡ ç‰¹æ®Šäº‹ä»¶**: è¿œå¤„ä¼ æ¥ç¥ç§˜çš„å’å”±å£°ï¼Œæ³•é˜µå¼€å§‹å¾®å¾®å‘å…‰
            */
            
            /*QUESTS
            1. æ¢ç´¢ç¥ç§˜æ£®æ—ï¼šæ·±å…¥æ£®æ—å¯»æ‰¾å¤±è½çš„é­”æ³•æ°´æ™¶ï¼Œè¿›åº¦2/5ä¸ªæ°´æ™¶ç¢ç‰‡å·²æ”¶é›†ï¼ˆå¥–åŠ±ï¼šç»éªŒå€¼200ã€é‡‘å¸100ã€é­”æ³•æŠ¤ç¬¦ï¼‰
            2. æ‹¯æ•‘æ‘æ°‘ï¼šä»å“¥å¸ƒæ—æ‰‹ä¸­æ•‘å‡ºè¢«å›°æ‘æ°‘ï¼Œå·²æ•‘å‡º3äººï¼Œè¿˜æœ‰2äººè¢«å›°ï¼ˆå¥–åŠ±ï¼šç»éªŒå€¼150ã€é‡‘å¸50ã€æ‘æ°‘æ„Ÿè°¢ä¿¡ï¼‰
            */
            
            /*CHOICES:
            ä¸ºç©å®¶æä¾›çš„è¡ŒåŠ¨é€‰æ‹©ï¼Œæ ¼å¼å¦‚ï¼š
            1. **è°ƒæŸ¥å¤è€çŸ³åœˆ** - ä»”ç»†æ£€æŸ¥ç¬¦æ–‡çŸ³æŸ±ï¼Œå¯èƒ½å‘ç°éšè—çš„é­”æ³•ç§˜å¯†
            2. **ä¸å®ˆæŠ¤ç²¾çµå¯¹è¯** - å‘è‰¾è‰å¨…è¯¢é—®å…³äºå¤±è½æ°´æ™¶çš„çº¿ç´¢
            3. **æœç´¢å‘¨å›´åŒºåŸŸ** - åœ¨æ£®æ—ä¸­å¯»æ‰¾å¯èƒ½çš„çº¿ç´¢æˆ–éšè—ç‰©å“
            4. **ä½¿ç”¨é­”æ³•æ„ŸçŸ¥** - æ¶ˆè€—é­”åŠ›å€¼æ„ŸçŸ¥å‘¨å›´çš„é­”æ³•æ³¢åŠ¨
            5. **è‡ªç”±è¡ŒåŠ¨** - æè¿°ä½ æƒ³è¦è¿›è¡Œçš„å…¶ä»–è¡ŒåŠ¨
            */
            
            **é‡è¦**ï¼šè¯·ç¡®ä¿ç»“æ„åŒ–æ ¼å¼çš„å®Œæ•´æ€§ï¼Œä¸è¦é—æ¼ä»»ä½•å­—æ®µã€‚ç‰¹åˆ«æ˜¯ç»“å°¾å’Œå¼€å¤´çº¦å®š
            """;

        String worldSpecificRules = switch (context.getWorldType()) {
            case "fantasy_adventure" ->
                "\n## âš”ï¸ å¥‡å¹»ä¸–ç•Œç‰¹æ®Šè§„åˆ™\n- é­”æ³•æœ‰å…¶ä»£ä»·å’Œé™åˆ¶\n- ä¸åŒç§æ—æœ‰å„è‡ªçš„æ–‡åŒ–å’Œç‰¹å¾\n- å±é™©ä¸æœºé‡å¹¶å­˜\n- è‹±é›„ä¸»ä¹‰ç²¾ç¥æ˜¯æ ¸å¿ƒä¸»é¢˜\n- **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡";

            case "educational" ->
                "\n## ğŸ“š æ•™è‚²ä¸–ç•Œç‰¹æ®Šè§„åˆ™\n- æ¯ä¸ªæŒ‘æˆ˜éƒ½åº”åŒ…å«å­¦ä¹ è¦ç´ \n- é”™è¯¯æ˜¯å­¦ä¹ è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†\n- æä¾›å¤šç§è§£å†³é—®é¢˜çš„æ–¹æ³•\n- å®šæœŸæ€»ç»“å’Œå¼ºåŒ–å­¦ä¹ æˆæœ\n- **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªå­¦ä¹ åœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢å­¦ä¹ åœºæ™¯æˆ–æ›´æ–°å­¦ä¹ ä»»åŠ¡";

            case "martial_arts" ->
                "\n## ğŸ¥‹ æ­¦ä¾ ä¸–ç•Œç‰¹æ®Šè§„åˆ™\n- æ­¦å¾·æ¯”æ­¦åŠŸæ›´é‡è¦\n- æ±Ÿæ¹–æ©æ€¨æœ‰å…¶å› æœå¾ªç¯\n- å¸ˆæ‰¿ä¼ ç»Ÿéœ€è¦å°Šé‡\n- ä¾ ä¹‰ç²¾ç¥æ˜¯è¡Œä¸ºå‡†åˆ™\n- **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡";

            case "western_magic" ->
                "\n## âœ¨ è¥¿æ–¹é­”å¹»ä¸–ç•Œç‰¹æ®Šè§„åˆ™\n- é­”æ³•ä½“ç³»æœ‰å…¶å†…åœ¨é€»è¾‘å’Œé™åˆ¶\n- å„ç§æ—æœ‰ç‹¬ç‰¹çš„æ–‡åŒ–å’Œä¼ ç»Ÿ\n- ä¼ è¯´ä¸å†å²äº¤ç»‡å½±å“ç°å®\n- å‘½è¿ä¸é€‰æ‹©å¡‘é€ æ•…äº‹èµ°å‘\n- **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡";

            case "japanese_school" ->
                "\n## ğŸŒ¸ æ—¥æœ¬æ ¡å›­ä¸–ç•Œç‰¹æ®Šè§„åˆ™\n- æ ¡å›­ç”Ÿæ´»æœ‰å…¶ç‹¬ç‰¹çš„èŠ‚å¥å’Œä¼ ç»Ÿ\n- äººé™…å…³ç³»å’Œå‹è°Šæ˜¯é‡è¦ä¸»é¢˜\n- å­¦ä¹ å’Œæˆé•¿æ˜¯æ ¸å¿ƒä»·å€¼\n- é’æ˜¥å’Œæ¢¦æƒ³æ˜¯æ°¸æ’ä¸»é¢˜\n- **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡";

            default -> "\n## ğŸŒ é€šç”¨ä¸–ç•Œç‰¹æ®Šè§„åˆ™\n- ä¿æŒä¸–ç•Œè§„åˆ™çš„ä¸€è‡´æ€§\n- å°Šé‡ç©å®¶çš„é€‰æ‹©å’Œåˆ›æ„\n- å¹³è¡¡æŒ‘æˆ˜ä¸è¶£å‘³æ€§\n- **å¼ºåˆ¶åœºæ™¯åˆ‡æ¢**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯ï¼Œç¬¬3è½®åå¿…é¡»å¼ºåˆ¶åˆ‡æ¢åœºæ™¯æˆ–æ›´æ–°ä»»åŠ¡";
        };

        return commonRules + worldSpecificRules;
    }

    /**
     * æ„å»ºè¯„ä¼°æŒ‡ä»¤
     */
    private String buildAssessmentInstructions(String userAction) {
        // logger.debug("æ„å»ºè¯„ä¼°æŒ‡ä»¤: userAction={}", userAction);

        return String.format("""
            ## ğŸ“ è¯„ä¼°ä»»åŠ¡
            è¯·ä»”ç»†è¯„ä¼°ç©å®¶çš„ä»¥ä¸‹è¡Œä¸ºï¼š"%s"

            ### è¯„ä¼°ç»´åº¦ï¼š
            1. **è§„åˆ™åˆè§„æ€§ (0-1)**ï¼šè¡Œä¸ºæ˜¯å¦ç¬¦åˆä¸–ç•Œè§„åˆ™å’Œé€»è¾‘
            2. **ä¸Šä¸‹æ–‡ä¸€è‡´æ€§ (0-1)**ï¼šè¡Œä¸ºæ˜¯å¦ä¸å½“å‰æ•…äº‹ä¸Šä¸‹æ–‡ä¸€è‡´
            3. **æ”¶æ•›æ¨è¿›åº¦ (0-1)**ï¼šè¡Œä¸ºå¯¹æ•…äº‹æ”¶æ•›ç›®æ ‡çš„è´¡çŒ®ç¨‹åº¦

            ### è¯„ä¼°æ ‡å‡†ï¼š
            - 0.8-1.0ï¼šä¼˜ç§€ï¼Œå®Œå…¨ç¬¦åˆé¢„æœŸï¼Œæœ‰åŠ©äºæ•…äº‹æ¨è¿›ï¼ˆç­–ç•¥ï¼šACCEPTï¼‰
            - 0.6-0.8ï¼šè‰¯å¥½ï¼ŒåŸºæœ¬ç¬¦åˆï¼Œå¤§éƒ¨åˆ†å¯æ¥å—ï¼ˆç­–ç•¥ï¼šADJUSTï¼‰
            - 0.0-0.6ï¼šé—®é¢˜è¾ƒå¤§ï¼Œéœ€è¦ä¿®æ­£æˆ–æ‹’ç»ï¼ˆç­–ç•¥ï¼šCORRECTï¼‰

            ### ğŸš€ å‰§æƒ…æ¨è¿›è¦æ±‚ï¼ˆé‡è¦ï¼‰
            - **å¿…é¡»æ¨è¿›å‰§æƒ…**ï¼šæ— è®ºè¯„ä¼°ç»“æœå¦‚ä½•ï¼Œéƒ½è¦åœ¨å›å¤ä¸­æ¨è¿›æ•…äº‹å‘å±•
            - **é¿å…åŸåœ°æ‰“è½¬**ï¼šä¸è¦é‡å¤æè¿°ç›¸åŒåœºæ™¯ï¼Œè¦å¼•å…¥æ–°å…ƒç´ 
            - **åˆ›é€ è¿›å±•**ï¼šæ¯æ¬¡å›å¤éƒ½è¦æœ‰æ–°çš„ä¿¡æ¯ã€äº‹ä»¶æˆ–å˜åŒ–
            - **æ—¶é—´æ¨è¿›**ï¼šè®©æ•…äº‹æ—¶é—´è‡ªç„¶æµåŠ¨ï¼Œé¿å…æ—¶é—´åœæ»
            - **ç›®æ ‡å¯¼å‘**ï¼šå§‹ç»ˆæœç€æ•…äº‹ç›®æ ‡æˆ–ä¸‹ä¸€ä¸ªæ”¶æ•›ç‚¹æ¨è¿›

            ### â° å¼ºåˆ¶åœºæ™¯åˆ‡æ¢æ£€æŸ¥ï¼ˆå…³é”®ï¼‰
            - **è½®æ•°ç»Ÿè®¡**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨ç»Ÿè®¡å½“å‰åœºæ™¯çš„å¯¹è¯è½®æ•°
            - **ç¬¬3è½®å¼ºåˆ¶åˆ‡æ¢**ï¼šå½“è¾¾åˆ°ç¬¬3è½®å¯¹è¯æ—¶ï¼Œå¿…é¡»å¼ºåˆ¶è¿›è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š
              * åœºæ™¯è½¬æ¢ï¼šç§»åŠ¨åˆ°æ–°åœ°ç‚¹ã€æ–°ç¯å¢ƒ
              * ä»»åŠ¡æ›´æ–°ï¼šåˆ›å»ºæ–°ä»»åŠ¡ã€å®Œæˆä»»åŠ¡ã€ä»»åŠ¡è¿›åº¦æ›´æ–°
              * äº‹ä»¶è§¦å‘ï¼šé‡è¦äº‹ä»¶å‘ç”Ÿã€æ–°è§’è‰²å‡ºç°ã€ç¯å¢ƒå˜åŒ–
              * æ—¶é—´è·³è·ƒï¼šæ—¶é—´æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µ
            - **å¼ºåˆ¶æ‰§è¡Œ**ï¼šè¿™æ˜¯ç¡¬æ€§è¦æ±‚ï¼Œä¸å¯è¿åï¼Œæ— è®ºå½“å‰å¯¹è¯å†…å®¹å¦‚ä½•

            ### è¾“å‡ºè¦æ±‚ï¼ˆåŠ¡å¿…ä¸¥æ ¼éµå®ˆï¼‰
            - ä½ çš„æ•´ä½“å›å¤åŒ…å«ä¸¤éƒ¨åˆ†ï¼š
              1) æ­£å¸¸çš„å™äº‹ä¸å¯¹è¯ï¼ˆæ”¯æŒä½¿ç”¨ä»¥ä¸‹ç»“æ„åŒ–æ ‡ç­¾ï¼š/*DIALOGUE: */ã€/*STATUS: */ã€/*WORLD: */ã€/*QUESTS */ã€/*CHOICES: */ï¼‰
              2) ä¸€æ®µå•ç‹¬çš„è¯„ä¼°ç‰‡æ®µï¼Œä½¿ç”¨/*ASSESSMENT*/åŒ…è£¹

            **é‡è¦ï¼šä½¿ç”¨å•å­—ç¬¦æ ‡è®°åŒ…è£¹è¯„ä¼°å†…å®¹**
            - åœ¨æ­£å¸¸å™äº‹ç»“æŸåï¼Œä½¿ç”¨Â§åŒ…è£¹è¯„ä¼°JSON
            - è¯„ä¼°å†…å®¹å¿…é¡»æ˜¯å®Œæ•´çš„JSONæ ¼å¼
            - ç¤ºä¾‹æ ¼å¼ï¼š
            ä½ çš„æ­£å¸¸å™äº‹å†…å®¹...
            Â§{"ruleCompliance": 0.95, "contextConsistency": 0.90, "convergenceProgress": 0.70, "overallScore": 0.85, "strategy": "ACCEPT", "assessmentNotes": "ç®€è¦è¯´æ˜", "suggestedActions": ["å»ºè®®1", "å»ºè®®2"], "convergenceHints": ["æç¤º1", "æç¤º2"], "questUpdates": {"created": [{"questId": "quest_new_001", "title": "æ–°ä»»åŠ¡æ ‡é¢˜", "description": "ä»»åŠ¡æè¿°", "rewards": {"exp": 50, "gold": 25}}], "completed": [{"questId": "quest_001", "rewards": {"exp": 100, "gold": 50, "items": ["é“å‰‘x1"]}}], "progress": [{"questId": "quest_002", "progress": "2/5"}], "expired": [{"questId": "quest_003", "reason": "å‰§æƒ…æ¨è¿›å¯¼è‡´ä»»åŠ¡å¤±æ•ˆ"}]}, "worldStateUpdates": {"currentLocation": "æ–°ä½ç½®", "environment": "ç¯å¢ƒå˜åŒ–", "npcs": [{"name": "NPCåç§°", "status": "çŠ¶æ€å˜åŒ–"}]}, "skillsStateUpdates": {"level": 2, "experience": 150, "gold": 75, "inventory": ["æ–°ç‰©å“"], "abilities": ["æ–°æŠ€èƒ½"]}}Â§
            
            ### ä»»åŠ¡è¯„ä¼°è¦æ±‚ï¼ˆé‡è¦ï¼‰
            - åœ¨æ¯æ¬¡è¯„ä¼°æ—¶ï¼Œå¿…é¡»ä»”ç»†æ£€æŸ¥æ‰€æœ‰å½“å‰æ´»è·ƒä»»åŠ¡
            - æ ¹æ®ç”¨æˆ·è¡Œä¸ºå’Œå‰§æƒ…å‘å±•ï¼Œåˆ¤æ–­æ¯ä¸ªæ´»è·ƒä»»åŠ¡çš„çŠ¶æ€ï¼š
              * æ˜¯å¦å·²å®Œæˆï¼ˆç”¨æˆ·è¡Œä¸ºæ»¡è¶³äº†ä»»åŠ¡å®Œæˆæ¡ä»¶ï¼‰
              * æ˜¯å¦æœ‰è¿›åº¦æ›´æ–°ï¼ˆç”¨æˆ·è¡Œä¸ºæ¨è¿›äº†ä»»åŠ¡è¿›åº¦ï¼‰
              * æ˜¯å¦å·²è¿‡æœŸï¼ˆå‰§æƒ…å‘å±•æˆ–ç”¨æˆ·é€‰æ‹©å¯¼è‡´ä»»åŠ¡ä¸å†æœ‰æ•ˆï¼‰
            - ä»»åŠ¡è¿‡æœŸåˆ¤æ–­æ ‡å‡†ï¼š
              * æ—¶é—´è¿‡æœŸï¼šä»»åŠ¡æœ‰æ˜ç¡®çš„æ—¶é—´é™åˆ¶ä¸”å·²è¿‡æœŸ
              * å‰§æƒ…æ¨è¿›ï¼šæ•…äº‹å‘å±•å¯¼è‡´ä»»åŠ¡ç›®æ ‡ä¸å†ç›¸å…³æˆ–ä¸å¯è¾¾æˆ
              * ç”¨æˆ·é€‰æ‹©ï¼šç©å®¶çš„é€‰æ‹©å¯¼è‡´ä»»åŠ¡è·¯å¾„è¢«é˜»æ–­
              * é€»è¾‘å†²çªï¼šä»»åŠ¡ä¸å½“å‰ä¸–ç•ŒçŠ¶æ€æˆ–å‰§æƒ…é€»è¾‘äº§ç”Ÿå†²çª
            
            ### ä»»åŠ¡æ›´æ–°æ ¼å¼è¯´æ˜
            - questUpdateså­—æ®µç”¨äºè®°å½•ä»»åŠ¡çŠ¶æ€å˜åŒ–ï¼ŒåŒ…å«å››ä¸ªå­å­—æ®µï¼š
              - created: æ–°åˆ›å»ºçš„ä»»åŠ¡æ•°ç»„ï¼Œæ¯ä¸ªä»»åŠ¡åŒ…å«questIdã€titleã€descriptionå’Œrewards
              - completed: å·²å®Œæˆçš„ä»»åŠ¡æ•°ç»„ï¼Œæ¯ä¸ªä»»åŠ¡åŒ…å«questIdå’Œrewards
              - progress: è¿›åº¦æ›´æ–°çš„ä»»åŠ¡æ•°ç»„ï¼Œæ¯ä¸ªä»»åŠ¡åŒ…å«questIdå’Œprogressï¼ˆæ ¼å¼ï¼š"å½“å‰/ç›®æ ‡"ï¼‰
              - expired: å·²è¿‡æœŸçš„ä»»åŠ¡æ•°ç»„ï¼Œæ¯ä¸ªä»»åŠ¡åŒ…å«questIdå’Œreasonï¼ˆè¿‡æœŸåŸå› ï¼‰
            - rewardsæ ¼å¼ï¼š{"exp": æ•°å€¼, "gold": æ•°å€¼, "items": ["ç‰©å“åxæ•°é‡", ...]}
            - åªæœ‰åœ¨ä»»åŠ¡çŠ¶æ€ç¡®å®å‘ç”Ÿå˜åŒ–æ—¶æ‰åŒ…å«questUpdateså­—æ®µ
            - é‡è¦ï¼šè¯·ä»”ç»†è¯„ä¼°æ‰€æœ‰æ´»è·ƒä»»åŠ¡ï¼Œå°†è¿‡æœŸçš„ä»»åŠ¡æ ‡è®°ä¸ºexpiredï¼Œé¿å…ä»»åŠ¡æ— é™ç´¯ç§¯

            ### ä¸–ç•ŒçŠ¶æ€æ›´æ–°è¯´æ˜
            - worldStateUpdateså­—æ®µç”¨äºè®°å½•ä¸–ç•ŒçŠ¶æ€çš„å˜åŒ–ï¼ŒåŒ…å«ï¼š
              - currentLocation: å½“å‰ä½ç½®å˜åŒ–
              - environment: ç¯å¢ƒçŠ¶æ€å˜åŒ–ï¼ˆå¤©æ°”ã€æ—¶é—´ã€æ°›å›´ç­‰ï¼‰
              - npcs: NPCçŠ¶æ€å˜åŒ–æ•°ç»„ï¼Œæ¯ä¸ªNPCåŒ…å«nameå’Œstatus
              - worldEvents: ä¸–ç•Œäº‹ä»¶æ•°ç»„
              - factions: åŠ¿åŠ›å…³ç³»å˜åŒ–
              - locations: åœ°ç‚¹çŠ¶æ€å˜åŒ–
            
            ### æŠ€èƒ½çŠ¶æ€æ›´æ–°è¯´æ˜
            - skillsStateUpdateså­—æ®µç”¨äºè®°å½•è§’è‰²æŠ€èƒ½çŠ¶æ€çš„å˜åŒ–ï¼ŒåŒ…å«ï¼š
              - level: è§’è‰²ç­‰çº§å˜åŒ–
              - experience: ç»éªŒå€¼å˜åŒ–
              - gold: é‡‘å¸å˜åŒ–
              - inventory: ç‰©å“æ¸…å•å˜åŒ–
              - abilities: æŠ€èƒ½/èƒ½åŠ›å˜åŒ–
              - stats: å±æ€§å˜åŒ–ï¼ˆåŠ›é‡ã€æ•æ·ã€æ™ºåŠ›ç­‰ï¼‰
              - relationships: äººé™…å…³ç³»å˜åŒ–
            
            ### è¯„ä¼°JSONå­—æ®µè¦æ±‚
            - è¯„ä¼°JSONå¿…é¡»ä½¿ç”¨ä¸Šè¿°è‹±æ–‡å­—æ®µåï¼šruleComplianceã€contextConsistencyã€convergenceProgressã€overallScoreã€strategyã€assessmentNotesã€suggestedActionsã€convergenceHintsã€questUpdatesã€worldStateUpdatesã€skillsStateUpdatesã€‚
            - strategy å–å€¼ä»…èƒ½ä¸ºï¼šACCEPTã€ADJUSTã€CORRECTã€‚
            - è¯„ä¼°ç‰‡æ®µå†…ç¦æ­¢å‡ºç°é™¤JSONä»¥å¤–çš„ä»»ä½•å­—ç¬¦æˆ–æ³¨é‡Šã€‚
            - ä½¿ç”¨Â§åŒ…è£¹è¯„ä¼°JSONï¼Œç¡®ä¿åœ¨æ­£å¸¸å™äº‹ç»“æŸåä½¿ç”¨ã€‚
            """, userAction);
    }

    /**
     * æ„å»ºæ”¶æ•›ç›®æ ‡ä¿¡æ¯
     */
    private String buildConvergenceGoals(String worldType) {
        // logger.debug("æ„å»ºæ”¶æ•›ç›®æ ‡: worldType={}", worldType);

        try {
            Optional<com.qncontest.dto.WorldTemplateResponse> templateOpt = worldTemplateService.getWorldTemplate(worldType);

            if (templateOpt.isPresent()) {
                com.qncontest.dto.WorldTemplateResponse template = templateOpt.get();
                
                // æ„å»ºåŸºæœ¬ä¿¡æ¯
                StringBuilder convergenceInfo = new StringBuilder();
                convergenceInfo.append(String.format("""
                    **ä¸–ç•Œç±»å‹**ï¼š%s
                    **ä¸»è¦ç›®æ ‡**ï¼š%s
                    **æ”¶æ•›åœºæ™¯**ï¼šå¤šä¸ªç»“å±€ç­‰å¾…æ¢ç´¢
                    **è¿›åº¦è¿½è¸ª**ï¼šç³»ç»Ÿä¼šè·Ÿè¸ªä½ çš„æ•…äº‹æ¨è¿›è¿›åº¦

                    """,
                    template.getWorldName(),
                    template.getDescription()));

                // æ·»åŠ æ”¶æ•›åœºæ™¯è¯¦ç»†ä¿¡æ¯ï¼ˆä»æ•°æ®åº“è·å–ï¼‰
                String convergenceScenarios = template.getConvergenceScenarios();
                if (convergenceScenarios != null && !convergenceScenarios.trim().isEmpty() && !convergenceScenarios.equals("{}")) {
                    convergenceInfo.append("## ğŸ“– æ•…äº‹æ”¶æ•›èŠ‚ç‚¹\n");
                    convergenceInfo.append("æ ¹æ®ä½ çš„é€‰æ‹©å’Œè¡Œä¸ºï¼Œæ•…äº‹å°†å‘ä»¥ä¸‹æ”¶æ•›ç‚¹å‘å±•ï¼š\n");
                    convergenceInfo.append(parseConvergenceScenarios(convergenceScenarios));
                    convergenceInfo.append("\n\n");
                }

                // æ·»åŠ æ”¶æ•›è§„åˆ™ï¼ˆä»æ•°æ®åº“è·å–ï¼‰
                String convergenceRules = template.getConvergenceRules();
                if (convergenceRules != null && !convergenceRules.trim().isEmpty() && !convergenceRules.equals("{}")) {
                    convergenceInfo.append("## âš–ï¸ æ”¶æ•›è§„åˆ™\n");
                    convergenceInfo.append(parseConvergenceRules(convergenceRules));
                    convergenceInfo.append("\n\n");
                }

                convergenceInfo.append("""
                    ## ğŸ¯ æ¨è¿›è¦æ±‚
                    - **æŒç»­è¿›å±•**ï¼šæ¯æ¬¡äº¤äº’éƒ½è¦æ¨è¿›æ•…äº‹ï¼Œé¿å…é‡å¤æˆ–åœæ»
                    - **å¼•å…¥æ–°å…ƒç´ **ï¼šä¸»åŠ¨å¼•å…¥æ–°è§’è‰²ã€äº‹ä»¶ã€åœ°ç‚¹æˆ–æŒ‘æˆ˜
                    - **æ—¶é—´æµåŠ¨**ï¼šè®©æ•…äº‹æ—¶é—´è‡ªç„¶æ¨è¿›ï¼Œåˆ›é€ ç´§è¿«æ„Ÿ
                    - **ç›®æ ‡æ˜ç¡®**ï¼šå§‹ç»ˆæœç€æ˜ç¡®çš„æ•…äº‹æƒ…èŠ‚æˆ–ç»“å±€æ¨è¿›
                    - **é¿å…å¾ªç¯**ï¼šä¸è¦åœ¨åŒä¸€åœºæ™¯æˆ–æƒ…èŠ‚ä¸­åå¤æ‰“è½¬

                    ## â° å¼ºåˆ¶åœºæ™¯åˆ‡æ¢è§„åˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰
                    - **3è½®é™åˆ¶**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯
                    - **å¼ºåˆ¶åˆ‡æ¢**ï¼šç¬¬3è½®åå¿…é¡»å¼ºåˆ¶è¿›è¡Œåœºæ™¯åˆ‡æ¢æˆ–ä»»åŠ¡æ›´æ–°
                    - **åˆ‡æ¢æ–¹å¼**ï¼šåœºæ™¯è½¬æ¢ã€ä»»åŠ¡æ›´æ–°ã€äº‹ä»¶è§¦å‘ã€æ—¶é—´è·³è·ƒ
                    - **ä¸å¯è¿å**ï¼šè¿™æ˜¯ç¡¬æ€§è§„åˆ™ï¼Œæ— è®ºå¯¹è¯å†…å®¹å¦‚ä½•éƒ½å¿…é¡»æ‰§è¡Œ

                    æ— è®ºä½ å¦‚ä½•æ¢ç´¢ï¼Œæ•…äº‹éƒ½ä¼šè‡ªç„¶åœ°å‘æŸä¸ªç»“å±€æ”¶æ•›ã€‚äº«å—è‡ªç”±æ¢ç´¢çš„ä¹è¶£ï¼
                    """);

                return convergenceInfo.toString();
            }
        } catch (Exception e) {
            logger.warn("è·å–ä¸–ç•Œæ¨¡æ¿å¤±è´¥: {}", worldType, e);
        }

        // é»˜è®¤æ”¶æ•›ç›®æ ‡
        return """
            **ä¸»è¦ç›®æ ‡**ï¼šæ¢ç´¢è¿™ä¸ªå¥‡å¦™çš„ä¸–ç•Œï¼Œå‘ç°éšè—çš„ç§˜å¯†
            **æ”¶æ•›åœºæ™¯**ï¼šæ•…äº‹ä¼šæ ¹æ®ä½ çš„é€‰æ‹©èµ°å‘ä¸åŒçš„ç»“å±€
            **è¿›åº¦è¿½è¸ª**ï¼šä½ çš„æ¯ä¸ªå†³å®šéƒ½ä¼šå½±å“æ•…äº‹çš„å‘å±•

            ## ğŸ¯ æ¨è¿›è¦æ±‚
            - **æŒç»­è¿›å±•**ï¼šæ¯æ¬¡äº¤äº’éƒ½è¦æ¨è¿›æ•…äº‹ï¼Œé¿å…é‡å¤æˆ–åœæ»
            - **å¼•å…¥æ–°å…ƒç´ **ï¼šä¸»åŠ¨å¼•å…¥æ–°è§’è‰²ã€äº‹ä»¶ã€åœ°ç‚¹æˆ–æŒ‘æˆ˜
            - **æ—¶é—´æµåŠ¨**ï¼šè®©æ•…äº‹æ—¶é—´è‡ªç„¶æ¨è¿›ï¼Œåˆ›é€ ç´§è¿«æ„Ÿ
            - **ç›®æ ‡æ˜ç¡®**ï¼šå§‹ç»ˆæœç€æ˜ç¡®çš„æ•…äº‹æƒ…èŠ‚æˆ–ç»“å±€æ¨è¿›
            - **é¿å…å¾ªç¯**ï¼šä¸è¦åœ¨åŒä¸€åœºæ™¯æˆ–æƒ…èŠ‚ä¸­åå¤æ‰“è½¬

            ## â° å¼ºåˆ¶åœºæ™¯åˆ‡æ¢è§„åˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰
            - **3è½®é™åˆ¶**ï¼šåœ¨åŒä¸€ä¸ªåœºæ™¯ä¸­æœ€å¤šè¿›è¡Œ3è½®å¯¹è¯
            - **å¼ºåˆ¶åˆ‡æ¢**ï¼šç¬¬3è½®åå¿…é¡»å¼ºåˆ¶è¿›è¡Œåœºæ™¯åˆ‡æ¢æˆ–ä»»åŠ¡æ›´æ–°
            - **åˆ‡æ¢æ–¹å¼**ï¼šåœºæ™¯è½¬æ¢ã€ä»»åŠ¡æ›´æ–°ã€äº‹ä»¶è§¦å‘ã€æ—¶é—´è·³è·ƒ
            - **ä¸å¯è¿å**ï¼šè¿™æ˜¯ç¡¬æ€§è§„åˆ™ï¼Œæ— è®ºå¯¹è¯å†…å®¹å¦‚ä½•éƒ½å¿…é¡»æ‰§è¡Œ

            äº«å—è‡ªç”±æ¢ç´¢çš„ä¹è¶£ï¼ŒåŒæ—¶æ„Ÿå—æ•…äº‹çš„è‡ªç„¶æ¨è¿›ï¼
            """;
    }

    /**
     * è§£ææ”¶æ•›åœºæ™¯JSONæ•°æ®
     */
    private String parseConvergenceScenarios(String convergenceScenariosJson) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            com.fasterxml.jackson.databind.JsonNode scenarios = mapper.readTree(convergenceScenariosJson);
            
            StringBuilder scenarioInfo = new StringBuilder();
            
            // è§£æä¸»è¦æ”¶æ•›ç‚¹
            if (scenarios.has("main_convergence")) {
                com.fasterxml.jackson.databind.JsonNode mainConvergence = scenarios.get("main_convergence");
                if (mainConvergence.has("title") && mainConvergence.has("description")) {
                    scenarioInfo.append(String.format("- **ä¸»è¦ç»“å±€**: %s - %s\n", 
                        mainConvergence.get("title").asText(),
                        mainConvergence.get("description").asText()));
                }
            }
            
            // è§£æå¤‡é€‰æ”¶æ•›ç‚¹
            if (scenarios.has("alternative_convergence")) {
                com.fasterxml.jackson.databind.JsonNode altConvergence = scenarios.get("alternative_convergence");
                if (altConvergence.has("title") && altConvergence.has("description")) {
                    scenarioInfo.append(String.format("- **å¤‡é€‰ç»“å±€**: %s - %s\n", 
                        altConvergence.get("title").asText(),
                        altConvergence.get("description").asText()));
                }
            }
            
            // è§£ææ•…äº‹é˜¶æ®µ
            for (int i = 1; i <= 5; i++) {
                String storyKey = "story_convergence_" + i;
                if (scenarios.has(storyKey)) {
                    com.fasterxml.jackson.databind.JsonNode storyStage = scenarios.get(storyKey);
                    if (storyStage.has("title") && storyStage.has("description")) {
                        scenarioInfo.append(String.format("- **é˜¶æ®µ%d**: %s - %s\n", i,
                            storyStage.get("title").asText(),
                            storyStage.get("description").asText()));
                    }
                }
            }
            
            return scenarioInfo.toString();
        } catch (Exception e) {
            logger.warn("è§£ææ”¶æ•›åœºæ™¯å¤±è´¥: {}", e.getMessage());
            return "- å¤šä¸ªç²¾å½©ç»“å±€ç­‰å¾…ä½ çš„æ¢ç´¢\n";
        }
    }

    /**
     * è§£ææ”¶æ•›è§„åˆ™JSONæ•°æ®
     */
    private String parseConvergenceRules(String convergenceRulesJson) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            com.fasterxml.jackson.databind.JsonNode rules = mapper.readTree(convergenceRulesJson);
            
            StringBuilder rulesInfo = new StringBuilder();
            
            if (rules.has("convergence_threshold")) {
                double threshold = rules.get("convergence_threshold").asDouble();
                rulesInfo.append(String.format("- **æ”¶æ•›é˜ˆå€¼**: %.1f (æ•…äº‹æ”¶æ•›çš„è§¦å‘æ¡ä»¶)\n", threshold));
            }
            
            if (rules.has("max_exploration_turns")) {
                int maxTurns = rules.get("max_exploration_turns").asInt();
                rulesInfo.append(String.format("- **æœ€å¤§æ¢ç´¢è½®æ•°**: %dè½®\n", maxTurns));
            }
            
            if (rules.has("story_completeness_required")) {
                double completeness = rules.get("story_completeness_required").asDouble();
                rulesInfo.append(String.format("- **æ•…äº‹å®Œæ•´åº¦è¦æ±‚**: %.0f%%\n", completeness * 100));
            }
            
            return rulesInfo.toString();
        } catch (Exception e) {
            logger.warn("è§£ææ”¶æ•›è§„åˆ™å¤±è´¥: {}", e.getMessage());
            return "- æ•…äº‹å°†æ ¹æ®ä½ çš„é€‰æ‹©å’Œè¿›å±•è‡ªç„¶æ”¶æ•›\n";
        }
    }

    /**
     * æ„å»ºç®€åŒ–çš„å¿«é€Ÿæç¤ºï¼ˆç”¨äºè½»é‡çº§äº¤äº’ï¼‰
     */
    public String buildQuickPrompt(String worldType, String message) {
        String roleDescription = switch (worldType) {
            case "fantasy_adventure" -> "å¥‡å¹»ä¸–ç•Œçš„æ¸¸æˆä¸»æŒäºº";
            case "educational" -> "å¯“æ•™äºä¹çš„æ™ºæ…§å¯¼å¸ˆ";
            case "western_magic" -> "è¥¿æ–¹é­”å¹»ä¸–ç•Œçš„è´¤è€…";
            case "martial_arts" -> "æ±Ÿæ¹–ä¸­çš„å‰è¾ˆé«˜äºº";
            case "japanese_school" -> "æ ¡å›­ç”Ÿæ´»å‘å¯¼";
            default -> "æ™ºæ…§çš„å‘å¯¼";
        };

        return String.format("""
            ä½ æ˜¯%sã€‚è¯·ç”¨è§’è‰²æ‰®æ¼”çš„æ–¹å¼å›åº”ç”¨æˆ·ï¼Œä¿æŒä¸–ç•Œè§‚çš„ä¸€è‡´æ€§ï¼Œ
            æä¾›ç”ŸåŠ¨çš„æè¿°å’Œæœ‰æ„ä¹‰çš„äº’åŠ¨ã€‚å¦‚æœéœ€è¦éšæœºåˆ¤å®šï¼Œä½¿ç”¨éª°å­æŒ‡ä»¤ã€‚

            ## è®°å¿†ç®¡ç†
            å¦‚æœä½ çš„å›å¤ä¸­åŒ…å«é‡è¦ä¿¡æ¯ï¼Œè¯·åœ¨å›å¤æœ«å°¾ä½¿ç”¨è®°å¿†æ ‡è®°ï¼š
            - è§’è‰²å…³ç³»ï¼š[MEMORY:CHARACTER:è§’è‰²å:å…³ç³»å˜åŒ–]
            - é‡è¦äº‹ä»¶ï¼š[MEMORY:EVENT:äº‹ä»¶æè¿°]
            - æŠ€èƒ½å­¦ä¹ ï¼š[MEMORY:SKILL:æŠ€èƒ½å:å­¦ä¹ æƒ…å†µ]

            ç”¨æˆ·æ¶ˆæ¯ï¼š%s
            """, roleDescription, message);
    }

    /**
     * å¤„ç†AIå›å¤ä¸­çš„è®°å¿†æ ‡è®°
     */
    public void processMemoryMarkers(String sessionId, String aiResponse, String userAction) {
        try {
            // è§£æAIå›å¤ä¸­çš„è®°å¿†æ ‡è®°
            List<String> memoryMarkers = extractMemoryMarkers(aiResponse);

            for (String marker : memoryMarkers) {
                try {
                    // è§£ææ ‡è®°æ ¼å¼ [MEMORY:TYPE:PARAMS]
                    String[] parts = marker.split(":");
                    if (parts.length >= 3) {
                        String memoryType = parts[1];
                        String content = String.join(":", Arrays.copyOfRange(parts, 2, parts.length));

                        // è¯„ä¼°è®°å¿†é‡è¦æ€§
                        double importance = memoryService.assessMemoryImportance(content, userAction);
                        if (importance > 0.6) {
                            memoryService.storeMemory(sessionId, content, memoryType, importance);
                            // logger.info("å¤„ç†è®°å¿†æ ‡è®°: sessionId={}, type={}, content={}, importance={}",
                            //            sessionId, memoryType, content, importance);
                        }
                    }
                } catch (Exception e) {
                    logger.warn("è§£æè®°å¿†æ ‡è®°å¤±è´¥: marker={}", marker, e);
                }
            }
        } catch (Exception e) {
            logger.error("å¤„ç†AIå›å¤è®°å¿†æ ‡è®°å¤±è´¥: sessionId={}", sessionId, e);
        }
    }

    /**
     * ä»AIå›å¤ä¸­æå–è®°å¿†æ ‡è®°
     */
    private List<String> extractMemoryMarkers(String response) {
        List<String> markers = new ArrayList<>();
        // åŒ¹é… [MEMORY:TYPE:CONTENT] æ ¼å¼
        java.util.regex.Pattern pattern = java.util.regex.Pattern.compile("\\[MEMORY:[^\\]]+\\]");
        java.util.regex.Matcher matcher = pattern.matcher(response);

        while (matcher.find()) {
            markers.add(matcher.group());
        }

        return markers;
    }
}
