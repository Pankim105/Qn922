# 指令处理系统使用指南

## 概述

本系统实现了完整的AI指令处理功能，支持6种不同类型的指令标记，用于在角色扮演游戏中实现各种游戏机制。

## 支持的指令类型

### 1. 骰子指令 [DICE:]

**用途**: 进行随机性判定、技能检定、战斗伤害等

**格式**: `[DICE:骰子表达式:检定描述]`

**支持的骰子表达式**:
- `d20` - 20面骰子
- `d20+3` - 20面骰子，+3修正
- `d20-2` - 20面骰子，-2修正
- `d20+3:15` - 20面骰子，+3修正，DC15难度等级
- `d6` - 6面骰子（伤害骰）
- `d100` - 百分比骰子

**示例**:
```
[DICE:d20+3:感知检定]
[DICE:d6:伤害掷骰]
[DICE:d20:攻击检定]
[DICE:d100:随机事件]
```

### 2. 任务指令 [QUEST:]

**用途**: 创建、更新或完成任务

**格式**: `[QUEST:操作:任务ID/标题:描述]`

**支持的操作**:
- `CREATE` - 创建新任务
- `UPDATE` - 更新任务进度
- `COMPLETE` - 完成任务

**示例**:
```
[QUEST:CREATE:探索神秘森林:深入森林寻找失落的魔法水晶，进度0/5个水晶碎片已收集（奖励：经验值200、金币100、魔法护符）]
[QUEST:UPDATE:quest_001:已找到2个水晶碎片，进度2/5]
[QUEST:COMPLETE:quest_001:成功收集了所有5个水晶碎片，获得了森林守护者的认可]
```

### 3. 状态更新指令 [STATE:]

**用途**: 更新游戏状态信息

**格式**: `[STATE:状态类型:状态值]`

**支持的状态类型**:
- `LOCATION` - 位置更新
- `INVENTORY` - 物品更新
- `RELATIONSHIP` - 关系更新
- `EMOTION` - 情绪更新

**示例**:
```
[STATE:LOCATION:进入神秘的精灵森林，周围环绕着高大的古树，空气中弥漫着魔法气息]
[STATE:INVENTORY:获得了魔法水晶x1，经验值+50]
[STATE:RELATIONSHIP:精灵王艾伦多:与主角的关系提升为友好，信任度+25]
[STATE:EMOTION:惊讶:发现隐藏的宝藏，情绪转为兴奋]
```

### 4. 角色发展指令 [CHARACTER:]

**用途**: 记录角色发展、技能提升、等级变化

**格式**: `[CHARACTER:发展类型:发展内容]`

**支持的发展类型**:
- `DEVELOPMENT` - 一般发展
- `SKILL` - 技能提升
- `LEVEL_UP` - 等级提升

**示例**:
```
[CHARACTER:DEVELOPMENT:通过不断练习，主角的剑术达到了新的境界，学会了新的剑技]
[CHARACTER:SKILL:感知技能从+3提升到+4]
[CHARACTER:LEVEL_UP:角色等级从3级提升到4级，获得新的技能点]
```

### 5. 世界扩展指令 [WORLD:]

**用途**: 扩展游戏世界，添加新内容

**格式**: `[WORLD:扩展类型:扩展内容]`

**支持的扩展类型**:
- `EXPAND` - 一般扩展
- `LOCATION` - 新地点
- `NPC` - 新角色
- `EVENT` - 新事件

**示例**:
```
[WORLD:EXPAND:发现了一个隐藏的地下城入口，里面充满了古老的魔法陷阱和宝藏]
[WORLD:LOCATION:精灵村庄 - 一个隐藏在森林深处的美丽村庄，居住着友善的精灵]
[WORLD:NPC:神秘商人 - 一个总是出现在关键时刻的神秘商人，出售稀有物品]
[WORLD:EVENT:月圆之夜 - 每个月的月圆之夜，森林中的魔法力量会达到顶峰]
```

### 6. 学习挑战指令 [CHALLENGE:]

**用途**: 在教育世界中创建学习挑战

**格式**: `[CHALLENGE:挑战类型:难度:具体题目]`

**支持的挑战类型**:
- `MATH` - 数学挑战
- `HISTORY` - 历史挑战
- `LANGUAGE` - 语言挑战

**支持的难度**:
- `简单` - 基础难度
- `普通` - 中等难度
- `困难` - 高难度
- `专家` - 专家级难度

**示例**:
```
[CHALLENGE:MATH:普通:请计算：∫(2x+1)dx 在 [0,1] 区间上的定积分结果是多少？]
[CHALLENGE:HISTORY:古代中国:秦始皇统一六国是在哪一年？]
[CHALLENGE:LANGUAGE:词汇:请解释"宵衣旰食"这个成语的含义和出处]
```

## 系统特性

### 1. 自动解析
- 系统会自动从AI回复中提取所有指令标记
- 支持多种指令同时出现在一个回复中
- 使用正则表达式进行精确匹配

### 2. 数据持久化
- 所有指令执行结果都会保存到数据库
- 支持事件溯源，可以追踪所有状态变化
- 自动生成校验和确保数据完整性

### 3. 错误处理
- 完善的异常处理机制
- 详细的日志记录
- 指令解析失败不会影响其他指令的执行

### 4. 事务支持
- 使用Spring事务管理
- 确保数据一致性
- 支持回滚机制

## 技术实现

### 核心组件
- `MemoryMarkerProcessor` - 主处理器
- `WorldStateManagerInterface` - 世界状态管理
- `WorldEvent` - 事件记录
- `DiceRoll` - 骰子记录

### 数据存储
- 世界状态存储在 `world_states` 表
- 事件记录存储在 `world_events` 表
- 骰子记录存储在 `dice_rolls` 表

### 性能优化
- 使用批量操作减少数据库访问
- 缓存常用数据
- 异步处理非关键指令

## 使用建议

1. **指令格式**: 严格按照指定格式编写指令，确保解析正确
2. **内容描述**: 提供详细、清晰的描述信息
3. **错误处理**: 在AI回复中包含适当的错误处理逻辑
4. **性能考虑**: 避免在单个回复中使用过多指令
5. **数据一致性**: 确保指令之间的逻辑一致性

## 扩展性

系统设计具有良好的扩展性，可以轻松添加新的指令类型：

1. 在 `extractInstructionMarkers` 方法中添加新的正则表达式
2. 在 `processInstructionMarker` 方法中添加新的处理分支
3. 实现对应的处理方法
4. 更新相关的事件类型和数据结构

这个指令处理系统为角色扮演游戏提供了强大的功能支持，让AI能够动态地管理游戏状态、执行游戏机制，为用户提供更加丰富和互动的游戏体验。
