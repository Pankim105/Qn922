# 更新日志

## [v2.1.0] - 2025-01-27

### 🚀 新增功能

#### 1. 评估系统增强
- **新增评估字段**：
  - `arcUpdates`: 情节更新信息（当前情节名称、起始轮数、总轮数）
  - `convergenceStatusUpdates`: 收敛状态更新信息（进度、场景、提示等）
- **数据库扩展**：
  - 新增 `convergence_status` 表
  - 扩展 `dm_assessments` 表，添加 `arc_updates` 和 `convergence_status_updates` 字段

#### 2. 收敛状态管理系统
- **ConvergenceStatusService**: 新增收敛状态管理服务
- **ConvergenceStatusRepository**: 新增收敛状态数据访问层
- **功能特性**：
  - 整体收敛进度跟踪
  - 最近收敛场景识别
  - 场景进度管理
  - 活跃引导提示管理

#### 3. 情节管理系统
- **情节跟踪**：自动跟踪当前情节名称、起始轮数、总轮数
- **情节更新**：AI可动态更新情节信息
- **历史记录**：在WorldEvent中记录情节变化

#### 4. 提示词工程优化
- **CHOICES格式强化**：强制要求使用分号(;)分隔选择项
- **评估JSON扩展**：新增arcUpdates和convergenceStatusUpdates字段说明
- **收敛状态集成**：在提示词中包含当前收敛状态信息

### 🔧 功能改进

#### 1. 游戏逻辑处理增强
- **AssessmentGameLogicProcessor**：
  - 新增 `processArcUpdates()` 方法处理情节更新
  - 新增 `processConvergenceStatusUpdates()` 方法处理收敛状态更新
  - 增强日志记录，提供详细的处理过程跟踪

#### 2. 流式响应处理优化
- **RetryableStreamResponseHandler**：
  - 修复角色扮演流中缺失的评估JSON处理
  - 新增 `processAssessmentGameLogic()` 方法
  - 增强错误处理和重试机制

#### 3. 数据库架构优化
- **表结构更新**：
  - 修正 `dice_rolls` 表字段（`timestamp` → `created_at`）
  - 移除 `dice_rolls` 表的 `seed` 字段
  - 优化索引结构

#### 4. 日志系统完善
- **全面日志增强**：
  - `AssessmentExtractor`: 详细的JSON提取过程日志
  - `AssessmentGameLogicProcessor`: 完整的游戏逻辑处理日志
  - `StreamResponseHandler`: 流式响应处理日志
  - `RetryableStreamResponseHandler`: 重试机制日志

### 🐛 错误修复

#### 1. 关键Bug修复
- **修复评估JSON处理缺失**：角色扮演流中评估JSON未被处理的问题
- **修复数据库字段不匹配**：Java实体与SQL脚本不一致的问题
- **修复提示词格式问题**：CHOICES格式要求不够明确的问题

#### 2. 数据一致性修复
- **实体字段同步**：确保Java实体与数据库表结构完全一致
- **索引优化**：修正数据库索引定义
- **约束完整性**：确保外键约束和数据类型正确

### 📊 性能优化

#### 1. 数据库性能
- **查询优化**：优化常用查询的索引结构
- **连接池配置**：优化数据库连接池参数
- **事务管理**：改进事务边界和隔离级别

#### 2. 内存管理
- **对象池化**：减少频繁对象创建
- **缓存策略**：优化热点数据缓存
- **垃圾回收**：优化GC参数配置

### 🔒 安全性增强

#### 1. 数据验证
- **输入验证**：增强所有用户输入的验证
- **SQL注入防护**：使用参数化查询
- **XSS防护**：输出数据转义

#### 2. 访问控制
- **权限细化**：更精细的API访问控制
- **令牌管理**：改进JWT令牌的生成和验证
- **会话安全**：增强会话管理安全性

### 📚 文档更新

#### 1. 架构文档
- **后端架构**：更新服务层和实体层文档
- **数据库设计**：更新表结构和关系文档
- **API文档**：更新接口说明和示例

#### 2. 功能文档
- **角色扮演系统**：更新游戏机制和评估系统文档
- **记忆系统**：更新记忆类型和处理逻辑文档
- **收敛机制**：新增收敛状态管理文档

#### 3. 开发文档
- **安装指南**：更新数据库初始化步骤
- **配置说明**：更新环境配置要求
- **故障排除**：新增常见问题解决方案

### 🧪 测试改进

#### 1. 单元测试
- **服务层测试**：新增ConvergenceStatusService测试
- **数据层测试**：新增Repository层测试
- **工具类测试**：增强工具类测试覆盖率

#### 2. 集成测试
- **API测试**：更新API接口测试用例
- **数据库测试**：新增数据库操作测试
- **流式响应测试**：增强流式处理测试

### 🔄 向后兼容性

#### 1. API兼容性
- **接口保持**：所有现有API接口保持不变
- **数据格式**：保持现有数据格式兼容
- **配置兼容**：保持现有配置参数兼容

#### 2. 数据迁移
- **自动迁移**：数据库结构变更自动处理
- **数据保留**：确保现有数据不丢失
- **版本兼容**：支持多版本数据格式

### 📈 监控和运维

#### 1. 日志监控
- **结构化日志**：统一日志格式和级别
- **性能指标**：新增关键性能指标监控
- **错误追踪**：增强错误日志和堆栈跟踪

#### 2. 健康检查
- **服务健康**：新增服务健康检查端点
- **依赖检查**：检查外部依赖服务状态
- **资源监控**：监控系统资源使用情况

### 🎯 下一步计划

#### 1. 短期目标
- [ ] 完善收敛状态可视化界面
- [ ] 优化AI提示词模板
- [ ] 增强错误处理机制

#### 2. 中期目标
- [ ] 实现多用户协作功能
- [ ] 添加故事导出功能
- [ ] 支持自定义世界模板

#### 3. 长期目标
- [ ] 集成更多AI模型
- [ ] 实现3D可视化界面
- [ ] 支持VR/AR体验

---

## [v2.0.0] - 2025-01-20

### 🚀 主要功能
- 完整的角色扮演系统
- 5种世界类型支持
- 智能记忆管理
- 流式AI响应
- 游戏机制集成

### 🔧 技术架构
- Spring Boot后端
- React前端
- MySQL数据库
- LangChain4j AI集成

---

**版本说明**：
- 主版本号：重大功能更新或架构变更
- 次版本号：新功能添加或重要改进
- 修订版本号：错误修复或小改进

**更新频率**：
- 主版本：每6个月
- 次版本：每月
- 修订版本：每周或根据需要


