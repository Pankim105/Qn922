# 角色扮演系统

QN Contest的核心功能模块，提供沉浸式的角色扮演体验，支持多种世界类型和智能AI角色引导。

## 系统概述

角色扮演系统基于智能AI对话，结合游戏机制和记忆管理，为用户提供个性化的角色扮演体验。系统支持5种不同的世界类型，每种世界都有专业的AI角色和独特的游戏机制。

## 核心特性

### 🎭 多世界支持
- **5种世界类型**: 异世界探险、西方魔幻、东方武侠、日式校园、寓教于乐
- **专业AI角色**: 每个世界都有专门的AI角色引导
- **独特游戏机制**: 每个世界都有特色的游戏规则和机制

### 🧠 智能故事生成
- **动态故事线**: 基于用户选择生成个性化故事
- **故事收敛机制**: 智能引导故事向预设结局发展
- **多结局支持**: 每个世界都有多个可能的结局

### 🎲 游戏机制集成
- **骰子检定**: 自动识别和执行骰子检定
- **任务系统**: 智能创建和管理任务
- **学习挑战**: 寓教于乐的学习内容
- **状态管理**: 实时跟踪角色和世界状态
- **情节管理**: 自动跟踪故事情节发展
- **收敛状态**: 智能引导故事向预设结局发展

## 世界类型详解

### 1. 异世界探险 (fantasy_adventure)

#### AI角色: 游戏主持人(DM)
- **角色定位**: 经验丰富的地下城主
- **引导风格**: 冒险导向，注重探索和战斗
- **特色功能**: 魔法系统、战斗机制、宝藏发现

#### 游戏机制
- **骰子检定**: d20系统，支持各种技能检定
- **战斗系统**: 回合制战斗，支持魔法和物理攻击
- **探索机制**: 随机事件生成，隐藏区域发现
- **任务类型**: 主线任务、支线任务、随机任务

#### 示例对话
```
用户: "我想探索这个神秘的洞穴"
AI: "你小心翼翼地进入洞穴，黑暗中传来奇怪的声音。请进行感知检定。"
系统: [DICE:d20+3:感知检定] 结果: 15
AI: "你敏锐地察觉到洞穴深处有微弱的魔法光芒。你决定..."
```

### 2. 西方魔幻 (western_magic)

#### AI角色: 贤者向导
- **角色定位**: 博学的魔法导师
- **引导风格**: 魔法导向，注重学习和成长
- **特色功能**: 魔法学习、法师职业、龙族传说

#### 游戏机制
- **魔法系统**: 元素魔法、咒语学习、法力管理
- **职业发展**: 法师、骑士、牧师等职业选择
- **龙族互动**: 与龙族的复杂关系系统
- **魔法物品**: 法杖、魔法书、护符等装备

#### 示例对话
```
用户: "我想学习火球术"
AI: "很好！学习火球术需要掌握基础的火元素理论。让我为你创建一个学习任务。"
系统: [QUEST:CREATE:学习火球术:掌握基础火元素魔法理论]
AI: "首先，你需要理解火元素的本质..."
```

### 3. 东方武侠 (martial_arts)

#### AI角色: 江湖前辈
- **角色定位**: 武林前辈，江湖经验丰富
- **引导风格**: 侠义导向，注重道德和武功
- **特色功能**: 武功修炼、门派系统、江湖恩怨

#### 游戏机制
- **武功系统**: 内功、外功、轻功、暗器
- **门派选择**: 少林、武当、峨眉等名门正派
- **江湖关系**: 正邪对立、门派恩怨、师徒关系
- **侠义值**: 道德选择影响故事发展

#### 示例对话
```
用户: "我想拜师学艺"
AI: "江湖中门派众多，每个门派都有其独特的武学传承。你想加入哪个门派？"
用户: "我想加入武当派"
AI: "武当派以太极拳和剑法闻名天下。让我为你安排拜师仪式..."
```

### 4. 日式校园 (japanese_school)

#### AI角色: 校园向导
- **角色定位**: 友善的校园前辈
- **引导风格**: 青春导向，注重友情和成长
- **特色功能**: 社团活动、校园祭典、青春恋爱

#### 游戏机制
- **社团系统**: 加入各种社团，发展兴趣爱好
- **校园活动**: 体育祭、文化祭、修学旅行
- **人际关系**: 同学关系、师生关系、恋爱关系
- **学业挑战**: 考试、作业、课外活动

#### 示例对话
```
用户: "我想参加社团活动"
AI: "学校有很多有趣的社团！有运动类的足球社、篮球社，文化类的文学社、美术社，还有音乐类的轻音社。你想了解哪个？"
用户: "我想了解轻音社"
AI: "轻音社是一个充满活力的社团！让我为你介绍社团的成员和活动..."
```

### 5. 寓教于乐 (educational)

#### AI角色: 智慧导师
- **角色定位**: 博学的教育者
- **引导风格**: 学习导向，注重知识获取
- **特色功能**: 学科学习、知识挑战、技能提升

#### 游戏机制
- **学科系统**: 数学、历史、语言、科学等
- **学习挑战**: 题目解答、知识竞赛、技能测试
- **成长系统**: 知识积累、技能提升、成就解锁
- **互动学习**: 与历史人物对话、科学实验等

#### 示例对话
```
用户: "我想学习数学"
AI: "很好！数学是逻辑思维的基础。让我为你创建一个数学学习挑战。"
系统: [CHALLENGE:MATH:3:计算 2x + 5 = 15 中x的值]
AI: "这是一个一元一次方程。让我们一步步解决..."
```

## 游戏机制详解

### 1. 骰子检定系统

#### 检定类型
- **技能检定**: 攻击、防御、感知、潜行等
- **属性检定**: 力量、敏捷、智力、魅力等
- **特殊检定**: 魔法检定、幸运检定、意志检定

#### 检定格式
```
[DICE:d20+5:攻击检定]
[DICE:d6:伤害]
[DICE:d100:百分比检定]
```

#### 检定结果
- **成功**: 达到或超过难度等级
- **失败**: 低于难度等级
- **大成功**: 掷出20（d20系统）
- **大失败**: 掷出1（d20系统）

### 2. 任务系统

#### 任务类型
- **主线任务**: 推进故事发展的核心任务
- **支线任务**: 丰富游戏体验的辅助任务
- **学习任务**: 寓教于乐的知识学习任务
- **随机任务**: 根据情况动态生成的任务

#### 任务格式
```
[QUEST:CREATE:任务名称:任务描述]
[QUEST:UPDATE:任务ID:更新内容]
[QUEST:COMPLETE:任务ID:完成说明]
```

#### 任务管理
- **任务创建**: AI自动识别需要创建任务的情况
- **任务更新**: 根据用户行为更新任务进度
- **任务完成**: 自动检测任务完成条件

### 3. 学习挑战系统

#### 挑战类型
- **数学挑战**: 算术、代数、几何等
- **历史挑战**: 历史事件、人物、文化等
- **语言挑战**: 词汇、语法、翻译等
- **科学挑战**: 物理、化学、生物等

#### 挑战格式
```
[CHALLENGE:MATH:3:计算 2x + 5 = 15 中x的值]
[CHALLENGE:HISTORY:古代:秦朝统一中国是在哪一年？]
[CHALLENGE:LANGUAGE:英语:翻译"Hello World"为中文]
```

#### 挑战机制
- **难度分级**: 1-5级难度，逐步提升
- **即时反馈**: 立即给出答案和解释
- **进度跟踪**: 记录学习进度和成绩

### 4. 状态管理系统

#### 状态类型
- **角色状态**: 生命值、法力值、经验值等
- **世界状态**: 地点、时间、天气等
- **关系状态**: 与NPC的关系、声望等
- **物品状态**: 装备、道具、金钱等

#### 状态更新格式
```
[STATE:LOCATION:魔法森林深处]
[STATE:INVENTORY:获得铁剑 +1]
[STATE:RELATIONSHIP:村长:友好度 +10]
[STATE:EMOTION:兴奋:发现了宝藏]
```

### 5. 评估系统

#### 评估JSON结构
AI模型会在每次回复中包含结构化的评估JSON，用于执行游戏逻辑：

```json
{
  "ruleCompliance": 0.95,
  "contextConsistency": 0.90,
  "convergenceProgress": 0.70,
  "overallScore": 0.85,
  "strategy": "ACCEPT",
  "assessmentNotes": "行为评估说明",
  "suggestedActions": ["建议行动1", "建议行动2"],
  "convergenceHints": ["收敛提示1", "收敛提示2"],
  "diceRolls": [
    {
      "diceType": 20,
      "modifier": 3,
      "context": "感知检定",
      "result": 15,
      "isSuccessful": true
    }
  ],
  "questUpdates": {
    "created": [{"questId": "quest_001", "title": "新任务", "description": "任务描述"}],
    "completed": [{"questId": "quest_002", "rewards": {"exp": 100}}],
    "progress": [{"questId": "quest_003", "progress": "2/5"}],
    "expired": [{"questId": "quest_004", "reason": "剧情推进"}]
  },
  "worldStateUpdates": {
    "currentLocation": "新位置",
    "environment": "环境变化",
    "npcs": [{"name": "NPC名称", "status": "状态变化"}]
  },
  "skillsStateUpdates": {
    "level": 2,
    "experience": 150,
    "gold": 75,
    "inventory": ["新物品"],
    "abilities": ["新技能"]
  },
  "arcUpdates": {
    "currentArcName": "新情节名称",
    "currentArcStartRound": 5,
    "totalRounds": 10
  },
  "convergenceStatusUpdates": {
    "progress": 0.75,
    "nearestScenarioId": "story_convergence_2",
    "nearestScenarioTitle": "远古神庙",
    "distanceToNearest": 0.3,
    "scenarioProgress": {
      "story_convergence_1": 1.0,
      "story_convergence_2": 0.75,
      "main_convergence": 0.2
    },
    "activeHints": ["寻找神庙入口", "收集古代符文"]
  }
}
```

#### 评估字段说明
- **ruleCompliance**: 规则合规性 (0-1)
- **contextConsistency**: 上下文一致性 (0-1)
- **convergenceProgress**: 收敛推进度 (0-1)
- **overallScore**: 综合评分 (0-1)
- **strategy**: 处理策略 (ACCEPT/ADJUST/CORRECT)
- **diceRolls**: 骰子检定结果数组
- **questUpdates**: 任务更新信息
- **worldStateUpdates**: 世界状态更新
- **skillsStateUpdates**: 技能状态更新
- **arcUpdates**: 情节更新信息
- **convergenceStatusUpdates**: 收敛状态更新

### 6. 情节管理系统

#### 情节跟踪
- **currentArcName**: 当前情节名称
- **currentArcStartRound**: 当前情节起始轮数
- **totalRounds**: 当前总轮数

#### 情节更新机制
- AI根据故事发展自动更新情节信息
- 系统记录情节变化历史
- 支持情节分支和合并

### 7. 收敛状态管理

#### 收敛状态字段
- **progress**: 整体收敛进度 (0-1)
- **nearestScenarioId**: 最近收敛场景ID
- **nearestScenarioTitle**: 最近收敛场景标题
- **distanceToNearest**: 到最近场景的距离
- **scenarioProgress**: 各场景进度映射
- **activeHints**: 活跃引导提示列表

#### 收敛引导机制
- 智能识别当前故事状态
- 计算到各收敛场景的距离
- 提供动态引导提示
- 跟踪收敛进度变化

## 故事收敛机制

### 1. 收敛原理
- **自由探索**: 用户可以进行任何想做的行为
- **智能引导**: AI根据用户行为智能引导故事发展
- **自然收敛**: 无论用户如何探索，最终都会收敛到预设结局

### 2. 收敛策略
- **渐进引导**: 从微妙提示到明确建议
- **多路径支持**: 支持多种到达结局的路径
- **动态调整**: 根据用户行为调整引导强度

### 3. 收敛场景
每个世界都有多个预设的收敛场景：
- **主要结局**: 故事的主要发展方向
- **备选结局**: 基于不同选择的结局
- **阶段收敛**: 故事发展过程中的关键节点

## 记忆系统集成

### 1. 自动记忆
- **重要事件**: 自动识别和存储重要事件
- **角色关系**: 跟踪与NPC的关系变化
- **世界变化**: 记录世界状态的重要变化

### 2. 记忆类型
- **CHARACTER**: 角色相关信息
- **EVENT**: 重要事件
- **RELATIONSHIP**: 人际关系
- **WORLD_STATE**: 世界状态
- **EMOTION**: 情绪状态
- **SKILL**: 技能学习
- **ITEM**: 物品相关
- **LOCATION**: 地点相关

### 3. 记忆格式
```
[MEMORY:EVENT:发现了古老的宝箱]
[MEMORY:CHARACTER:遇到了神秘的法师]
[MEMORY:WORLD:魔法森林的秘密通道]
```

## 使用指南

### 1. 开始游戏
1. 选择世界类型
2. 系统初始化角色和世界
3. 开始与AI角色对话

### 2. 游戏技巧
- **明确表达**: 清楚地描述你想要做的事情
- **关注提示**: AI会提供行动建议
- **尝试不同选择**: 探索不同的故事路径
- **利用游戏机制**: 主动使用骰子、任务等机制

### 3. 高级功能
- **自定义规则**: 通过上帝模式自定义世界规则
- **会话管理**: 保存和恢复游戏会话
- **故事导出**: 导出游戏故事记录

## 技术实现

### 1. 提示词构建
- **分层提示词**: 世界规则、状态、记忆、任务
- **动态更新**: 根据游戏进展动态更新提示词
- **个性化**: 根据用户偏好调整AI角色

### 2. 流式响应
- **实时响应**: 支持流式AI响应
- **交互体验**: 低延迟的用户交互
- **长对话支持**: 支持长时间的游戏会话

### 3. 状态同步
- **实时更新**: 游戏状态实时同步
- **版本控制**: 状态变更的版本管理
- **数据一致性**: 确保数据的一致性

## 性能优化

### 1. 响应速度
- **AI响应**: 平均响应时间 < 2秒
- **状态更新**: 状态更新延迟 < 100ms
- **记忆检索**: 记忆检索时间 < 50ms

### 2. 并发支持
- **同时在线**: 支持1000+同时在线用户
- **并发对话**: 支持500+并发对话
- **资源管理**: 智能资源分配和管理

## 扩展计划

### 1. 短期目标
- [ ] 更多世界类型
- [ ] 语音交互支持
- [ ] 移动端适配

### 2. 中期目标
- [ ] 多用户协作
- [ ] 自定义AI角色
- [ ] 高级记忆分析

### 3. 长期目标
- [ ] 3D可视化
- [ ] VR/AR支持
- [ ] 社区功能

## 总结

角色扮演系统是QN Contest的核心功能，通过智能AI对话、游戏机制集成和记忆管理，为用户提供沉浸式的角色扮演体验。系统支持多种世界类型，每种世界都有独特的游戏机制和AI角色，确保用户能够获得丰富多样的游戏体验。

系统的设计注重用户体验，支持自由探索和智能引导，既保证了游戏的自由度，又确保了故事的连贯性和完整性。通过持续的技术优化和功能扩展，系统将不断提供更好的角色扮演体验。
