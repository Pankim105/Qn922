# è¯„ä¼°ç³»ç»Ÿ

QN Contestçš„æ™ºèƒ½è¯„ä¼°ç³»ç»Ÿæ˜¯æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œé€šè¿‡AIæ¨¡å‹å¯¹ç”¨æˆ·è¡Œä¸ºè¿›è¡Œå®æ—¶è¯„ä¼°ï¼Œå¹¶è‡ªåŠ¨æ‰§è¡Œç›¸åº”çš„æ¸¸æˆé€»è¾‘æ›´æ–°ã€‚

## ç³»ç»Ÿæ¦‚è¿°

è¯„ä¼°ç³»ç»ŸåŸºäºAIæ¨¡å‹çš„æ™ºèƒ½åˆ†æï¼Œå°†ç”¨æˆ·è¡Œä¸ºè½¬åŒ–ä¸ºç»“æ„åŒ–çš„è¯„ä¼°æ•°æ®ï¼Œå¹¶è‡ªåŠ¨æ‰§è¡Œæ¸¸æˆé€»è¾‘æ›´æ–°ï¼ŒåŒ…æ‹¬éª°å­æ£€å®šã€ä»»åŠ¡ç®¡ç†ã€çŠ¶æ€æ›´æ–°ã€æƒ…èŠ‚ç®¡ç†ç­‰ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ§  æ™ºèƒ½è¯„ä¼°
- **å¤šç»´åº¦è¯„ä¼°**: è§„åˆ™åˆè§„æ€§ã€ä¸Šä¸‹æ–‡ä¸€è‡´æ€§ã€æ”¶æ•›æ¨è¿›åº¦
- **å®æ—¶å¤„ç†**: æ¯æ¬¡AIå›å¤éƒ½åŒ…å«è¯„ä¼°JSON
- **è‡ªåŠ¨æ‰§è¡Œ**: è¯„ä¼°ç»“æœè‡ªåŠ¨è½¬åŒ–ä¸ºæ¸¸æˆé€»è¾‘æ›´æ–°

### ğŸ² æ¸¸æˆæœºåˆ¶é›†æˆ
- **éª°å­æ£€å®š**: è‡ªåŠ¨è¯†åˆ«å’Œæ‰§è¡Œéª°å­æ£€å®š
- **ä»»åŠ¡ç³»ç»Ÿ**: æ™ºèƒ½åˆ›å»ºã€æ›´æ–°ã€å®Œæˆä»»åŠ¡
- **å­¦ä¹ æŒ‘æˆ˜**: å¯“æ•™äºä¹çš„å­¦ä¹ å†…å®¹
- **çŠ¶æ€ç®¡ç†**: å®æ—¶æ›´æ–°è§’è‰²å’Œä¸–ç•ŒçŠ¶æ€

### ğŸ“Š æ•°æ®è¿½è¸ª
- **å®Œæ•´è®°å½•**: æ‰€æœ‰è¯„ä¼°æ•°æ®æŒä¹…åŒ–å­˜å‚¨
- **å†å²åˆ†æ**: æ”¯æŒè¯„ä¼°å†å²æŸ¥è¯¢å’Œåˆ†æ
- **æ€§èƒ½ç›‘æ§**: å®æ—¶ç›‘æ§è¯„ä¼°ç³»ç»Ÿæ€§èƒ½

## è¯„ä¼°æµç¨‹

### 1. ç”¨æˆ·è¡Œä¸ºè¾“å…¥
ç”¨æˆ·é€šè¿‡èŠå¤©ç•Œé¢è¾“å…¥è¡Œä¸ºæè¿°ï¼Œç³»ç»Ÿå°†è¡Œä¸ºä¼ é€’ç»™AIæ¨¡å‹ã€‚

### 2. AIè¯„ä¼°åˆ†æ
AIæ¨¡å‹åŸºäºä»¥ä¸‹ç»´åº¦å¯¹ç”¨æˆ·è¡Œä¸ºè¿›è¡Œè¯„ä¼°ï¼š

#### è¯„ä¼°ç»´åº¦
- **è§„åˆ™åˆè§„æ€§ (ruleCompliance)**: è¡Œä¸ºæ˜¯å¦ç¬¦åˆä¸–ç•Œè§„åˆ™å’Œé€»è¾‘ (0-1)
- **ä¸Šä¸‹æ–‡ä¸€è‡´æ€§ (contextConsistency)**: è¡Œä¸ºæ˜¯å¦ä¸å½“å‰æ•…äº‹ä¸Šä¸‹æ–‡ä¸€è‡´ (0-1)
- **æ”¶æ•›æ¨è¿›åº¦ (convergenceProgress)**: è¡Œä¸ºå¯¹æ•…äº‹æ”¶æ•›ç›®æ ‡çš„è´¡çŒ®ç¨‹åº¦ (0-1)

#### è¯„ä¼°æ ‡å‡†
- **0.8-1.0**: ä¼˜ç§€ï¼Œå®Œå…¨ç¬¦åˆé¢„æœŸï¼Œæœ‰åŠ©äºæ•…äº‹æ¨è¿›ï¼ˆç­–ç•¥ï¼šACCEPTï¼‰
- **0.6-0.8**: è‰¯å¥½ï¼ŒåŸºæœ¬ç¬¦åˆï¼Œå¤§éƒ¨åˆ†å¯æ¥å—ï¼ˆç­–ç•¥ï¼šADJUSTï¼‰
- **0.0-0.6**: é—®é¢˜è¾ƒå¤§ï¼Œéœ€è¦ä¿®æ­£æˆ–æ‹’ç»ï¼ˆç­–ç•¥ï¼šCORRECTï¼‰

### 3. è¯„ä¼°JSONç”Ÿæˆ
AIæ¨¡å‹ç”Ÿæˆç»“æ„åŒ–çš„è¯„ä¼°JSONï¼ŒåŒ…å«è¯„ä¼°ç»“æœå’Œæ¸¸æˆé€»è¾‘æ›´æ–°ä¿¡æ¯ã€‚

### 4. æ¸¸æˆé€»è¾‘å¤„ç†
ç³»ç»Ÿè§£æè¯„ä¼°JSONï¼Œè‡ªåŠ¨æ‰§è¡Œç›¸åº”çš„æ¸¸æˆé€»è¾‘æ›´æ–°ã€‚

## è¯„ä¼°JSONç»“æ„

### åŸºç¡€è¯„ä¼°å­—æ®µ
```json
{
  "ruleCompliance": 0.95,
  "contextConsistency": 0.90,
  "convergenceProgress": 0.70,
  "overallScore": 0.85,
  "strategy": "ACCEPT",
  "assessmentNotes": "è¡Œä¸ºè¯„ä¼°è¯´æ˜",
  "suggestedActions": ["å»ºè®®è¡ŒåŠ¨1", "å»ºè®®è¡ŒåŠ¨2"],
  "convergenceHints": ["æ”¶æ•›æç¤º1", "æ”¶æ•›æç¤º2"]
}
```

### æ¸¸æˆæœºåˆ¶å­—æ®µ

#### éª°å­æ£€å®š (diceRolls)
```json
"diceRolls": [
  {
    "diceType": 20,
    "modifier": 3,
    "context": "æ„ŸçŸ¥æ£€å®š",
    "result": 15,
    "isSuccessful": true
  }
]
```

#### å­¦ä¹ æŒ‘æˆ˜ (learningChallenges)
```json
"learningChallenges": [
  {
    "type": "MATH",
    "difficulty": "æ™®é€š",
    "question": "è®¡ç®—2+2ç­‰äºå‡ ï¼Ÿ",
    "answer": "4",
    "isCorrect": true
  }
]
```

#### çŠ¶æ€æ›´æ–° (stateUpdates)
```json
"stateUpdates": [
  {
    "type": "LOCATION",
    "value": "è¿›å…¥å›¾ä¹¦é¦†ï¼Œä¹¦é¦™æ°”æ¯æ‰‘é¢è€Œæ¥"
  },
  {
    "type": "INVENTORY",
    "value": "è·å¾—äº†é­”æ³•ä¹¦x1ï¼Œæ™ºåŠ›+5"
  }
]
```

#### ä»»åŠ¡æ›´æ–° (questUpdates)
```json
"questUpdates": {
  "created": [
    {
      "questId": "quest_new_001",
      "title": "æ–°ä»»åŠ¡æ ‡é¢˜",
      "description": "ä»»åŠ¡æè¿°",
      "rewards": {"exp": 50, "gold": 25}
    }
  ],
  "completed": [
    {
      "questId": "quest_001",
      "rewards": {"exp": 100, "gold": 50, "items": ["é“å‰‘x1"]}
    }
  ],
  "progress": [
    {
      "questId": "quest_002",
      "progress": "2/5"
    }
  ],
  "expired": [
    {
      "questId": "quest_003",
      "reason": "å‰§æƒ…æ¨è¿›å¯¼è‡´ä»»åŠ¡å¤±æ•ˆ"
    }
  ]
}
```

#### ä¸–ç•ŒçŠ¶æ€æ›´æ–° (worldStateUpdates)
```json
"worldStateUpdates": {
  "currentLocation": "æ–°ä½ç½®",
  "environment": "ç¯å¢ƒå˜åŒ–",
  "npcs": [
    {
      "name": "NPCåç§°",
      "status": "çŠ¶æ€å˜åŒ–"
    }
  ]
}
```

#### æŠ€èƒ½çŠ¶æ€æ›´æ–° (skillsStateUpdates)
```json
"skillsStateUpdates": {
  "level": 2,
  "experience": 150,
  "gold": 75,
  "inventory": ["æ–°ç‰©å“"],
  "abilities": ["æ–°æŠ€èƒ½"],
  "stats": {
    "åŠ›é‡": 12,
    "æ•æ·": 10,
    "æ™ºåŠ›": 15,
    "ä½“è´¨": 11
  }
}
```

#### æƒ…èŠ‚æ›´æ–° (arcUpdates)
```json
"arcUpdates": {
  "currentArcName": "æ–°æƒ…èŠ‚åç§°",
  "currentArcStartRound": 5,
  "totalRounds": 10
}
```

#### æ”¶æ•›çŠ¶æ€æ›´æ–° (convergenceStatusUpdates)
```json
"convergenceStatusUpdates": {
  "progress": 0.75,
  "nearestScenarioId": "story_convergence_2",
  "nearestScenarioTitle": "è¿œå¤ç¥åº™",
  "distanceToNearest": 0.3,
  "scenarioProgress": {
    "story_convergence_1": 1.0,
    "story_convergence_2": 0.75,
    "main_convergence": 0.2
  },
  "activeHints": ["å¯»æ‰¾ç¥åº™å…¥å£", "æ”¶é›†å¤ä»£ç¬¦æ–‡"]
}
```

## å¤„ç†æµç¨‹

### 1. è¯„ä¼°JSONæå–
```java
@Service
public class AssessmentExtractor {
    
    public String extractAssessmentJson(String fullResponse) {
        // æŸ¥æ‰¾è¯„ä¼°JSONæ ‡è®°
        String startMarker = "Â§{";
        String endMarker = "}Â§";
        
        int startIndex = fullResponse.indexOf(startMarker);
        int endIndex = fullResponse.lastIndexOf(endMarker);
        
        if (startIndex != -1 && endIndex != -1 && endIndex > startIndex) {
            return fullResponse.substring(startIndex + 1, endIndex + 1);
        }
        
        return null;
    }
}
```

### 2. æ¸¸æˆé€»è¾‘å¤„ç†
```java
@Service
public class AssessmentGameLogicProcessor {
    
    @Transactional
    public void processAssessmentGameLogic(String sessionId, String assessmentJson) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            JsonNode assessment = mapper.readTree(assessmentJson);
            
            // å¤„ç†å„ç§æ¸¸æˆé€»è¾‘
            processDiceRolls(sessionId, assessment);
            processLearningChallenges(sessionId, assessment);
            processStateUpdates(sessionId, assessment);
            processQuestUpdates(sessionId, assessment);
            processWorldStateUpdates(sessionId, assessment);
            processSkillsStateUpdates(sessionId, assessment);
            processArcUpdates(sessionId, assessment);
            processConvergenceStatusUpdates(sessionId, assessment);
            
        } catch (Exception e) {
            logger.error("å¤„ç†è¯„ä¼°æ¸¸æˆé€»è¾‘å¤±è´¥: {}", e.getMessage(), e);
        }
    }
}
```

### 3. æ•°æ®æŒä¹…åŒ–
æ‰€æœ‰è¯„ä¼°æ•°æ®å’Œå¤„ç†ç»“æœéƒ½ä¼šæŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼š

- **dm_assessments**: å­˜å‚¨å®Œæ•´çš„è¯„ä¼°è®°å½•
- **dice_rolls**: å­˜å‚¨éª°å­æ£€å®šç»“æœ
- **learning_challenges**: å­˜å‚¨å­¦ä¹ æŒ‘æˆ˜è®°å½•
- **world_events**: å­˜å‚¨ä¸–ç•Œäº‹ä»¶è®°å½•
- **convergence_status**: å­˜å‚¨æ”¶æ•›çŠ¶æ€ä¿¡æ¯

## é”™è¯¯å¤„ç†

### 1. JSONè§£æé”™è¯¯
- æ•è·JSONè§£æå¼‚å¸¸
- è®°å½•é”™è¯¯æ—¥å¿—
- ç»§ç»­å¤„ç†å…¶ä»–å­—æ®µ

### 2. æ•°æ®åº“æ“ä½œé”™è¯¯
- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- è®°å½•æ“ä½œå¤±è´¥æ—¥å¿—
- æä¾›é”™è¯¯æ¢å¤æœºåˆ¶

### 3. ä¸šåŠ¡é€»è¾‘é”™è¯¯
- éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
- å¤„ç†è¾¹ç•Œæƒ…å†µ
- æä¾›é»˜è®¤å€¼

## æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥å¤„ç†
- è¯„ä¼°å¤„ç†å¼‚æ­¥æ‰§è¡Œ
- é¿å…é˜»å¡ä¸»æµç¨‹
- æé«˜å“åº”é€Ÿåº¦

### 2. æ‰¹é‡æ“ä½œ
- æ‰¹é‡æ•°æ®åº“æ“ä½œ
- å‡å°‘æ•°æ®åº“è¿æ¥å¼€é”€
- æé«˜å¤„ç†æ•ˆç‡

### 3. ç¼“å­˜ç­–ç•¥
- ç¼“å­˜å¸¸ç”¨æ•°æ®
- å‡å°‘é‡å¤è®¡ç®—
- æé«˜ç³»ç»Ÿæ€§èƒ½

## ç›‘æ§å’Œæ—¥å¿—

### 1. å¤„ç†æ—¥å¿—
```java
logger.info("å¼€å§‹å¤„ç†è¯„ä¼°æ¸¸æˆé€»è¾‘: sessionId={}, assessmentLength={}", 
           sessionId, assessmentJson.length());

logger.debug("è§£æéª°å­æ£€å®š: count={}", diceRolls.size());
logger.debug("è§£æä»»åŠ¡æ›´æ–°: created={}, completed={}, progress={}, expired={}", 
           questUpdates.get("created").size(),
           questUpdates.get("completed").size(),
           questUpdates.get("progress").size(),
           questUpdates.get("expired").size());
```

### 2. æ€§èƒ½ç›‘æ§
- å¤„ç†æ—¶é—´ç»Ÿè®¡
- æˆåŠŸç‡ç›‘æ§
- é”™è¯¯ç‡è·Ÿè¸ª

### 3. ä¸šåŠ¡æŒ‡æ ‡
- è¯„ä¼°åˆ†å¸ƒç»Ÿè®¡
- æ¸¸æˆé€»è¾‘æ‰§è¡Œç»Ÿè®¡
- ç”¨æˆ·è¡Œä¸ºåˆ†æ

## æ‰©å±•æ€§

### 1. æ–°æ¸¸æˆæœºåˆ¶
- æ”¯æŒæ·»åŠ æ–°çš„æ¸¸æˆæœºåˆ¶å­—æ®µ
- æä¾›æ‰©å±•æ¥å£
- ä¿æŒå‘åå…¼å®¹

### 2. è‡ªå®šä¹‰è¯„ä¼°
- æ”¯æŒè‡ªå®šä¹‰è¯„ä¼°ç»´åº¦
- æä¾›è¯„ä¼°æ’ä»¶æœºåˆ¶
- æ”¯æŒç¬¬ä¸‰æ–¹é›†æˆ

### 3. å¤šæ¨¡å‹æ”¯æŒ
- æ”¯æŒä¸åŒçš„AIæ¨¡å‹
- æä¾›æ¨¡å‹é€‚é…å™¨
- æ”¯æŒæ¨¡å‹åˆ‡æ¢

## ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºç¡€è¯„ä¼°
```json
{
  "ruleCompliance": 0.9,
  "contextConsistency": 0.85,
  "convergenceProgress": 0.6,
  "overallScore": 0.78,
  "strategy": "ACCEPT",
  "assessmentNotes": "ç”¨æˆ·è¡Œä¸ºç¬¦åˆæ¸¸æˆè§„åˆ™ï¼Œæœ‰åŠ©äºæ•…äº‹å‘å±•"
}
```

### 2. å¤æ‚æ¸¸æˆé€»è¾‘
```json
{
  "ruleCompliance": 0.95,
  "contextConsistency": 0.90,
  "convergenceProgress": 0.80,
  "overallScore": 0.88,
  "strategy": "ACCEPT",
  "diceRolls": [
    {
      "diceType": 20,
      "modifier": 5,
      "context": "æ”»å‡»æ£€å®š",
      "result": 18,
      "isSuccessful": true
    }
  ],
  "questUpdates": {
    "completed": [
      {
        "questId": "quest_001",
        "rewards": {"exp": 100, "gold": 50}
      }
    ]
  },
  "skillsStateUpdates": {
    "level": 3,
    "experience": 250,
    "gold": 125
  }
}
```

## æœ€ä½³å®è·µ

### 1. è¯„ä¼°å‡†ç¡®æ€§
- æä¾›æ¸…æ™°çš„è¯„ä¼°æ ‡å‡†
- å®šæœŸæ ¡å‡†è¯„ä¼°æ¨¡å‹
- æ”¶é›†ç”¨æˆ·åé¦ˆ

### 2. æ€§èƒ½ä¼˜åŒ–
- åˆç†è®¾ç½®å¤„ç†è¶…æ—¶
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
- ä½¿ç”¨é€‚å½“çš„ç¼“å­˜ç­–ç•¥

### 3. é”™è¯¯å¤„ç†
- å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

### 4. æ•°æ®å®‰å…¨
- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- è®¿é—®æƒé™æ§åˆ¶
- å®¡è®¡æ—¥å¿—è®°å½•

---

**è¯„ä¼°ç³»ç»Ÿæ˜¯QN Contestçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œé€šè¿‡æ™ºèƒ½è¯„ä¼°å’Œè‡ªåŠ¨æ¸¸æˆé€»è¾‘å¤„ç†ï¼Œä¸ºç”¨æˆ·æä¾›æµç•…çš„è§’è‰²æ‰®æ¼”ä½“éªŒã€‚**


