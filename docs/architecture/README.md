# 系统架构总览

QN Contest是一个基于微服务架构的智能角色扮演AI系统，采用前后端分离的设计模式。

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                            │
├─────────────────────────────────────────────────────────────┤
│  Web前端 (React)  │  UI组件库 (React)  │  移动端 (未来)      │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                        API网关层                             │
├─────────────────────────────────────────────────────────────┤
│           Spring Boot REST API + WebSocket                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                        业务服务层                            │
├─────────────────────────────────────────────────────────────┤
│  认证服务  │  聊天服务  │  角色扮演服务  │  记忆服务  │  世界服务 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                        数据访问层                            │
├─────────────────────────────────────────────────────────────┤
│  JPA/Hibernate  │  Redis缓存  │  文件存储  │  外部API      │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                        数据存储层                            │
├─────────────────────────────────────────────────────────────┤
│     MySQL数据库    │    Redis缓存    │    文件系统        │
└─────────────────────────────────────────────────────────────┘
```

## 技术栈

### 后端技术栈
- **框架**: Spring Boot 3.x
- **安全**: Spring Security + JWT
- **数据库**: MySQL 8.0 + JPA/Hibernate
- **缓存**: Redis (可选)
- **AI集成**: LangChain4j + DashScope
- **构建工具**: Maven
- **Java版本**: 17+

### 前端技术栈
- **框架**: React 18 + TypeScript
- **构建工具**: Vite
- **UI库**: 自定义组件库 + Tailwind CSS
- **状态管理**: React Hooks
- **HTTP客户端**: Axios
- **包管理**: npm/yarn

### 外部服务
- **AI服务**: 阿里云DashScope (通义千问)
- **语音服务**: 浏览器Web Speech API
- **部署**: Docker (可选)

## 核心模块

### 1. 认证模块
- JWT令牌认证
- 刷新令牌机制
- 用户权限管理
- 会话管理

### 2. 聊天模块
- 流式AI对话
- 消息历史管理
- 会话持久化
- 实时通信

### 3. 角色扮演模块
- 世界模板管理
- 角色状态跟踪
- 游戏机制集成
- 故事收敛系统

### 4. 记忆模块
- 智能记忆存储
- 上下文检索
- 重要性评估
- 记忆清理

### 5. 世界管理模块
- 世界状态管理
- 事件记录
- 版本控制
- 数据一致性

## 架构特点

### 1. 微服务架构
- 模块化设计，职责清晰
- 独立部署，易于扩展
- 接口标准化，便于维护

### 2. 前后端分离
- 前端专注于用户交互
- 后端专注于业务逻辑
- API标准化，支持多端

### 3. 流式处理
- 实时AI响应
- 低延迟用户体验
- 支持长对话场景

### 4. 数据驱动
- 配置化管理
- 动态内容生成
- 灵活的世界设定

## 设计原则

### 1. 单一职责原则
每个模块都有明确的职责，避免功能耦合。

### 2. 开闭原则
对扩展开放，对修改关闭，支持新功能添加。

### 3. 依赖倒置原则
高层模块不依赖低层模块，都依赖于抽象。

### 4. 接口隔离原则
客户端不应该依赖它不需要的接口。

## 性能考虑

### 1. 缓存策略
- Redis缓存热点数据
- 本地缓存减少数据库访问
- CDN加速静态资源

### 2. 数据库优化
- 索引优化查询性能
- 分页查询减少内存占用
- 连接池管理数据库连接

### 3. 异步处理
- 流式响应提升用户体验
- 异步任务处理耗时操作
- 消息队列解耦服务

## 安全设计

### 1. 认证安全
- JWT令牌认证
- 令牌过期机制
- 刷新令牌轮换

### 2. 数据安全
- 输入验证和过滤
- SQL注入防护
- XSS攻击防护

### 3. 通信安全
- HTTPS加密传输
- API限流防护
- 跨域请求控制

## 扩展性设计

### 1. 水平扩展
- 无状态服务设计
- 负载均衡支持
- 数据库读写分离

### 2. 功能扩展
- 插件化架构
- 接口标准化
- 配置化管理

### 3. 多端支持
- 响应式设计
- API标准化
- 组件复用

## 监控和运维

### 1. 日志管理
- 结构化日志记录
- 日志级别控制
- 日志聚合分析

### 2. 性能监控
- 接口响应时间
- 数据库性能
- 系统资源使用

### 3. 错误处理
- 统一异常处理
- 错误日志记录
- 自动恢复机制

## 详细文档

- [后端架构](backend-architecture.md) - 后端详细设计
- [前端架构](frontend-architecture.md) - 前端详细设计（UI组件库 + Web应用）
- [数据库设计](database-design.md) - 数据库结构设计
- [API设计](api-design.md) - API接口设计

## 版本历史

- **v2.0** (2025-01-27) - 重构为微服务架构
- **v1.0** (2024-12-01) - 初始版本发布

---

**架构设计遵循现代软件工程最佳实践，确保系统的可维护性、可扩展性和高性能。**
