## 角色扮演 AI Web 应用产品规划（PRD v1）

### 1. 面向用户与痛点、用户故事
- 用户类型
  - 学生与终身学习者：希望沉浸式学习历史、语言、科学；痛点是枯燥与难坚持。
  - ACG 与奇幻爱好者：渴望沉浸式世界互动；痛点是缺少可持续的高质量剧情与自由度。
  - 内容创作者/GM：需要快速构建世界观、人物、剧情；痛点是前期世界搭建成本高、复用差。
  - 轻度玩家与亲子用户：想要轻度娱乐寓教于乐；痛点是上手门槛、转化为可留存的纪念内容。

- 典型用户故事
  - 作为学生，我想与“苏格拉底”对话练习提问法，系统能记录要点并生成学习卡片。
  - 作为奇幻爱好者，我想探索“西方魔幻”世界，由AI叙述者给我任务，支持语音对话与骰子判定。
  - 作为创作者，我想扮演“创世上帝”，通过文本/语音定义世界规则、种族与势力，然后在此规则中生成主线与支线。
  - 作为家长，我想要“寓教于乐”的数学与历史任务，孩子过关后可导出一本个性化冒险故事书。

### 2. 世界观与范围（来自需求）
- 首批 5 个世界：
  1) 异世界探险（开放探索/任务引导）
  2) 西方魔幻（职业与派系、魔法规则）
  3) 东方武侠历史（门派、江湖、朝堂格局）
  4) 日式校园（日常/社团/事件树）
  5) 寓教于乐（数学、历史、语言学习关卡与历史名人援助事件）
- 世界进度：每次探险会积累“世界状态”，结算时生成用户独有的冒险故事（可导出）。
- 上帝模式：用户可定义全局规则、势力、资源，以此约束剧情生成与行为判定。

### 3. 功能列表与优先级（MoSCoW）
- Must（本期MVP实现）
  - 世界选择与上帝模式设定（基础规则、种族、势力）
  - 角色扮演语音/文本聊天（ASR 语音转文字、TTS 语音播报、LLM 回复流式显示）
  - 世界状态与剧情推进（任务/事件流转、简单骰子检定）
  - 学习向世界：数学/历史/语言关卡问答与即时反馈（至少 1 条主线）
  - 故事总结与导出（本地生成 Markdown/HTML）
  - 会话与历史持久化（已具备基础后端能力，需扩展世界与规则字段）

- Should
  - 角色与物品（背包/技能/属性）可视化卡片
  - 世界地图/关系图占位视图
  - 多角色（名人/叙事者/NPC）轮替发言

- Could
  - 成就系统与周目标
  - 合作模式（家长与孩子协作）
  - 导出为可打印 PDF 图书



### 4. 本期交付范围（迭代目标）
- 前端
  - 新增“世界选择 + 上帝模式设定”面板：内置 5 个世界的默认规则模板，可自定义覆盖。
  - 角色扮演对话区：文本输入、录音按钮（ASR）与播报（TTS），支持流式回复与技能调用按钮。
  - 技能区（至少 3 项）：
    1) 任务与日志（Quest Log）：创建/推进/完成任务，自动生成要点摘要。
    2) 骰子与判定（Dice Check）：d20 通用检定，可带修正值，影响剧情分支。
    3) 学习关卡（Quiz/Challenge）：数学/历史/语言题型，引导讲解并计分。
    4) 故事书生成（Story Export）：将关键节点串联为故事，导出 Markdown/HTML（作为加分项）。
  - 世界状态侧边栏：显示世界规则、当前地点、关系与势力影响度（基础文本版）。

- 后端
  - 沿用现有 /api/chat/stream SSE 接口；在 systemPrompt 中注入世界规则与上帝模式约束；传入技能状态与世界状态摘要。
  - 扩展会话结构：session 元数据新增 worldId、worldRules、godModeRules、skillsState 摘要字段（兼容旧会话）。
  - 对学习关卡的评分逻辑与任务状态变更由前端驱动，后端记录摘要以便续玩与总结。

### 5. LLM 模型选择与对比
- 候选
  - 阿里通义千问（通过 LangChain4j DashScope：qwen-plus / qwen2 系列）
  - OpenAI（gpt-4o/4.1-mini）
  - Google（Gemini 1.5 Pro/Flash）

- 选择：通义千问（DashScope，经由 LangChain4j 已集成）
  - 原因：
    - 已有后端集成与流式处理；落地成本最低。
    - 中文角色扮演、长对话表现稳定，成本可控，国内可用性更好。
    - 支持温度/最大 Token 配置，便于在“上帝模式约束 + 世界规则”场景调参。
  - 备选策略：若出现可用性/合规限制，可在配置层切换至 OpenAI/Gemini（保持接口一致）。

### 6. AI 角色技能设计（语音外的能力）
- 叙事推进（Narrative Director）：基于世界规则生成事件树与分支建议。
- 任务与日志（Quest Log）：结构化记录任务目标、进度与战利品；支持“总结要点”。
- 骰子/检定（Dice Check）：提供 d20 检定，系统将检定结果注入下一轮 systemPrompt 以影响剧情。
- 学习关卡（Quiz/Challenge）：
  - 数学：口算/应用题分级；
  - 历史：名人事件线问答；
  - 语言：词汇/会话情景练习；
  - 即时反馈并给出讲解；累计“成长值”。
- 世界状态摘要（World State）：将地点、角色、势力影响度形成简明摘要，持续注入 systemPrompt。
- 故事书导出（Story Export）：基于关键节点与世界状态生成个性化故事文本。

### 7. 交互与信息架构（IA）
- 顶部：世界选择与上帝模式设置（可展开抽屉）
- 左侧：世界状态与任务面板（可折叠）
- 中央：对话区（文本/语音）+ 技能按钮（骰子、任务、关卡、导出）
- 右侧：历史与会话管理（沿用现有 EnhancedAIChat 的会话能力）

### 8. 数据结构（草案）
- worldId: string（five presets: isekai, western_fantasy, wuxia_history, jp_school, edutainment）
- worldRules: object（从模板派生，可被上帝模式覆盖）
- godModeRules: object（用户自定义世界基础规则/势力/资源）
- skillsState: object
  - questLog: { quests: Quest[] }
  - diceHistory: { rolls: {d: number, mod?: number, result: number, note?: string}[] }
  - quizProgress: { track: 'math'|'history'|'language', score: number, level: number }
- storyCheckpoints: { ts: number, title: string, summary: string }[]

### 9. 系统提示词策略
- 基础 systemPrompt 结构：
  1) 世界规则摘要（worldRules + godModeRules 合并）
  2) 当前世界状态摘要（地点/事件/势力影响度/任务）
  3) 叙事指令：维持设定、一致口吻、分步推进、必要时提供可供选择的 2-3 个分支
  4) 安全与教育指引（未成年人友好、学术严谨、避免不当内容）

### 10. 语音链路
- ASR：浏览器 Web Speech API（首选）/ 本地 Whisper（可选，后期）
- TTS：浏览器 SpeechSynthesis 优先；若不满足再考虑 Edge/Safari 能力探测与降级
- 仅做“语音→LLM→语音”，不引入工具/外部 Agent

### 11. 成功度量（MVP 指标）
- 次日留存 ≥ 25%
- 平均会话轮次 ≥ 12
- 故事导出占比 ≥ 20%
- 学习向世界关卡完成率 ≥ 40%

### 12. 路线图（两周冲刺）
- Week 1
  - 规则模板与系统提示拼装（5 个世界 + 上帝模式覆盖）
  - 对话区 + 语音链路（ASR/TTS）
  - 任务/日志、骰子检定、学习关卡（题库样例）前端状态管理
  - 扩展会话元数据结构（后端）

- Week 2
  - 世界状态摘要注入与分支推进优化
  - 故事导出（MD/HTML）
  - 可视化卡片与基础地图/关系占位
  - 指标埋点与留存实验

### 13. 风险与对策
- 语音 API 兼容性：提供能力探测与纯文本降级。
- LLM 成本与速率：优先 qwen-plus，设定合理 maxTokens；必要时压缩历史摘要。
- 教育内容准确性：关键知识点走结构化模板与参考答案校验。
- “上帝模式”过度自由导致跑题：以规则检查清单约束，并在 systemPrompt 强化一致性。

### 14. 验收清单（本期完成即通过）
- 5 个世界模板与上帝模式 UI
- 语音聊天可用（ASR/TTS）
- 至少 3 项技能可用：任务日志、骰子检定、学习关卡
- 故事导出可用（文本）
- 会话持久化包含世界与规则元数据


